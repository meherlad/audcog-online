<html>

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
        integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="static/main.css">

    <title> AudCog - Great Minds </title>

</head>

<body>
    <header class="site-header">
        <nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top" id="audcog_header">
            <div class="container">
                <a class="navbar-brand mx-auto" href="/"> AudCog: Great
                    Minds</a>
            </div>
        </nav>
    </header>

    <main role="main" class="container-fluid py-2">
        <div class="row justify-content-center">
            <div class="col">
            </div>

            <!-- Appearances of all divs in this container are run by main.js -->
            <div class="col-md-12">

                <!-- Title Div is shown to guide a participant through task -->
                <div class="content-section text-center font-weight-bold border-0 h3" id="title_div">
                </div>

                <div class="progress" style="height: 30px;">
                    <div class="progress-bar progress-bar-striped bg-info" id=progressBar role="progressbar"
                        style="width: 0%" aria-valuemin="0" aria-valuemax="100"></div>
                </div>

                <!-- This Error Div comes up if the browser is not Chrome or the Screen is less than 1000 pixels wide and 500 pixels high -->
                <div class="content-section" id="browser_device_error" style='display:none'>
                    <p> This device or browser is not supported OR </p>
                    <p> Your screen is too small </p>
                    <p> Please use Google Chrome on a Desktop or Laptop computer </p>
                    <p> Try maximizing your browser window and refresh the webpage </p>
                </div>

                <div class="content-section" id="id_error" style='display:none'>
                    <p> Your ID is not registered to take part </p>
                    <p> Or there is an error in the way it is entered </p>
                    <p> </p>
                    <p> Please contact
                        <span class="font-weight-bold">audcog@ncl.ac.uk
                        </span>for more information
                    </p>
                </div>

                <!-- Login Page is shown when someone first encounters the website -->
                <div class="content-section text-center border-0 p-5" id="login_div">
                    <h6 class="text-dark font-weight-normal py-2"> Press the <span class="font-weight-bold"> 'START'
                        </span>button below to <span class="font-weight-bold">Begin </span></h5>
                        <div>
                            <div class='p-2'>
                                <button id='submitbutton' class="btn btn-dark border-dark font-weight-bold py-2"
                                    type='button'> START </button>
                            </div>
                        </div>
                        <div class="text-center">
                            <input id='dashPassword' type='text' class='p-4' style='visibility:hidden'>
                        </div>
                        <div class="text-danger font-weight-bold p-2">
                            <a id="error_message"> </a>
                        </div>
                        <h6 class="text-danger font-weight-normal"> <span class="font-weight-bold"> WARNING: </span> Do
                            not use Safari as a web browser. Remember to use Headphones too! </h5>
                </div>

                <!-- Controller Div is shown when an experimenter wants to test a task -->
                <div class="content-section text-center border-0" id="controller_div" style='display:none'>
                    <div class="form-group" id="debrief_div" style='display:none'>
                        <div class="col m-3 p-3 border border-secondary rounded bg-light">
                            <h5 class="text-muted p-2"> Thank you for participating in the AudCog study. </h5>
                            <h5 class="text-muted p-2"> You contribution will help us understand the link between
                                hearing ability and risk for dementia. </h5>
                            <h5 class="text-muted p-2"> As mentioned previously, these were research tests only so we do
                                not provide any feedback on performance. </h5>
                            <hr>
                            <h5 class="text-muted p-2"> You are eligible for a Â£50 Amazon voucher </h5>
                            <h6 class="text-muted font-weight-light p-2"> If you would like to be entered into a draw
                                for this, please email the
                                address below </h6>
                            <h6 class="text-muted font-weight-normal p-2"> audcog@ncl.ac.uk </h6>
                        </div>
                        <h5 class="text-dark font-weight-normal p-1"> You may now close this window </h5>
                    </div>
                </div>

                <!-- Auditory Working Memory Task Div is shown when begins the task run on awm.js -->
                <div class="content-section text-center border-0" id="awm_div" style='display:none'>
                </div>

            </div>
        </div>
    </main>

    <!-- Optional JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/p5@1.4.0/lib/p5.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/addons/p5.sound.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.8.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.8.1/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.8.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.8.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/7.1.0/math.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script src='https://unpkg.com/simple-statistics@7.7.0/dist/simple-statistics.min.js'></script>
    <script src="https://cdn.plot.ly/plotly-2.6.3.min.js"></script>

    <script>
        // Login to Firebase Database
        let userID, database, taskresults;
        window.addEventListener('DOMContentLoaded', (event) => {
            console.log('DOM fully loaded and parsed');
            // Browser and device checks
            const isChrome = /chrome/.test(navigator.userAgent.toLowerCase());
            const isSuitable = true; //(window.innerWidth > 400) && (window.innerHeight > 200)

            // Doesn't have to be Chrome for the time being
            if (isSuitable) {

                userID = getUserIDFromQueryString();

                if (!userID) { // Check if userID is null or empty
                    document.getElementById('login_div').style.display = 'none';
                    document.getElementById('id_error').style.display = 'block';
                }


                // Your web app's Firebase configuration
                const firebaseConfig = {
                    apiKey: "AIzaSyDPTy_twUrqEXlVfpALoqYkPdcux7klcEQ",
                    authDomain: "audcog-online.firebaseapp.com",
                    databaseURL: "https://audcog-online-default-rtdb.europe-west1.firebasedatabase.app",
                    projectId: "audcog-online",
                    storageBucket: "audcog-online.appspot.com",
                    messagingSenderId: "652871235053",
                    appId: "1:652871235053:web:7776007488c3ccf30163e4",
                    measurementId: "G-PCY56CPWHB"
                };
                // Initialize Firebase
                firebase.initializeApp(firebaseConfig);
                firebase.analytics();
                database = firebase.database();
                taskresults = database.ref('audcog-online');
                auth = firebase.auth();

            } else {
                login_div.style.display = 'none';
                browser_device_error_div.style.display = 'block';
            };
        });

        // Authenticate User and Create global variables needed to store in Database
        let database_uid, allVisits, userVisits;

        // Function to extract userID from the query string
        function getUserIDFromQueryString() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('userID');
        }

        document.getElementById('submitbutton').addEventListener('click', function () {
            login_div.style.display = 'none';
            document.getElementById('awm_div').style.display = 'block';
            createAWM();
        });

        // This script includes code for controlling the state of the Experimental workflow
        //
        // In debugging mode, a p5js canvas displays buttons that allow a user to test each task
        // 
        // In experimental mode, the user is taken directly to a set of general instructions and progresses to each task
        //
        let date = new Date;
        let timings = {
            expStartTime: `${("0" + (date.getHours())).slice(-2)}` + `${("0" + (date.getMinutes())).slice(-2)}`,
            expFinishTime: 0,
            awmStartTime: 0,
            awmFinishTime: 0,
        };

        // Generic Classes and Functions

        class Button {
            constructor(locX, locY, rad, p5instance) {
                this.x = locX;
                this.y = locY;
                this.rad = rad;
                this.hovering = false;
                this.p5instance = p5instance;
            };
            show(p5instance) {
                p5instance.push();
                p5instance.fill(255, 255, 255, 150);
                p5instance.stroke(100);
                p5instance.strokeWeight(1);
                p5instance.circle(this.x, this.y, this.rad);
                p5instance.pop();
            };
            hover(px, py, p5instance) {
                if (p5instance.dist(px, py, this.x, this.y) < this.rad / 2) {
                    p5instance.push();
                    p5instance.fill('red');
                    p5instance.stroke(100);
                    p5instance.strokeWeight(3);
                    p5instance.circle(this.x, this.y, this.rad + 10);
                    this.hovering = true;
                    p5instance.pop();
                } else {
                    this.hovering = false;
                };
            };
        }

        // All clickable buttons with words, during the response phase, are produced with this class
        class choiceBox {
            constructor(x, y, text) {
                this.x = x;
                this.y = y;
                this.width = 100;
                this.height = 50;
                this.textSize = 20
                this.text = text;
                this.over = false;
                this.pressed = false;
                this.fillVal = 225;
            }

            show(p5instance) {
                p5instance.push();
                p5instance.fill(this.fillVal);
                p5instance.rectMode(p5instance.CENTER);
                p5instance.rect(this.x, this.y, this.width, this.height, 10);
                p5instance.fill(0);
                p5instance.textSize(this.textSize);
                p5instance.textAlign(p5instance.CENTER, p5instance.CENTER);
                p5instance.text(this.text, this.x, this.y);
                p5instance.strokeWeight(2);
                p5instance.stroke(255);
                p5instance.pop();
            }

            mouseisover(px, py) {
                if (this.pressed == false) {
                    if ((Math.abs(this.x - px) < this.width / 2) && (Math.abs(this.y - py) < this.height / 2)) {
                        this.fillVal = 200;
                        this.over = true;
                    } else {
                        this.fillVal = 225;
                        this.over = false;
                    };
                } else {
                    if ((Math.abs(this.x - px) < this.width / 2) && (Math.abs(this.y - py) < this.height / 2)) {
                        this.fillVal = 100;
                        this.over = true;
                    } else {
                        this.fillVal = 125;
                        this.over = false;
                    };
                };
            }

            clicked() {
                this.fillVal = 125;
                this.pressed = true;
            }
        }

        class playButton {
            constructor(locX1, locX2, locY1, locY2, locZ1, locZ2) {
                this.x1 = locX1;
                this.y1 = locY1;
                this.z1 = locZ1;
                this.x2 = locX2;
                this.y2 = locY2;
                this.z2 = locZ2;
                this.hovering = false;
                this.pressed = false;
                this.fillVal = 'red';
            };
            show(p5instance) {
                p5instance.push();
                p5instance.fill('white');
                p5instance.rect(this.x1 + 25, this.z2, 100, 80);
                p5instance.fill(this.fillVal);
                if (!this.pressed) {
                    p5instance.triangle(this.x1, this.x2, this.y1, this.y2, this.z1, this.z2);
                } else {
                    p5instance.rect(this.x1 + 10, this.z2, 20, 60);
                    p5instance.rect(this.x1 + 40, this.z2, 20, 60);
                };
                p5instance.pop();
            };
            hover(px, py, p5instance) {
                if (p5instance.dist(px, py, this.z1 - 25, this.z2) < 50) {
                    p5instance.push();
                    p5instance.fill('grey');
                    p5instance.rect(this.x1 + 25, this.z2, 100, 80);
                    p5instance.fill(this.fillVal);
                    if (!this.pressed) {
                        p5instance.triangle(this.x1, this.x2, this.y1, this.y2, this.z1, this.z2);
                    } else {
                        p5instance.rect(this.x1 + 10, this.z2, 20, 60);
                        p5instance.rect(this.x1 + 40, this.z2, 20, 60);
                    };
                    p5instance.pop();
                    this.hovering = true;
                } else {
                    this.hovering = false;
                };
            };
            clicked() {
                this.pressed = !this.pressed;
                if (this.pressed) {
                    this.fillVal = 'green';
                } else {
                    this.fillVal = 'red';
                };
            };
        }

        // Global Experimental Variables

        // audcog controls event handlers for each task
        let audcog = {
            awm: true,
        }

        // Some Helper Functions
        //
        // Shuffle array function
        function shuffle(array) {
            let currentIndex = array.length, randomIndex;
            // While there remain elements to shuffle
            while (currentIndex != 0) {
                // Pick a remaining element
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                // And swap it with the current element
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            };
            return array;
        }

        // Create evently spaced values from startValue to stopValue
        function linSpace(startValue, stopValue, cardinality) {
            var arr = [];
            var step = (stopValue - startValue) / (cardinality - 1);
            for (var i = 0; i < cardinality; i++) {
                arr.push(startValue + (step * i));
            }
            return arr;
        }

        let flashInstructAlpha = 255; let flashPracticeInstructAlpha = 255; let flashInstructFadeRate = 5;

        // AWM Task code below

        let awmExpHandler, sliderX, Xtransform;
        let awmExpVars = {
            clickAllow: true,
            trial: 0,
            trialMatches: 0,
            trialMatchParams: [],
            trialRT: 0,
            nTrials: 32,
            progress: 0,
            pracTrials: 4,
            segCountdown: 3,
            segTrials: 16,
            pracOrder: [0, 2, 0, 2],
            pracLoad: [1, 1, 1, 1],
            pracStims1: [550, 8, 770, 16],
            pracStims2: [-1, 550, -1, 8],
            pracCues: [-1, 0, -1, 1],
            expOrder: [],
            expLoad: [],
            freqRange: [440, 880],
            expStims1: [],
            expStims2: [],
            expCues: [],
        }

        let awmResponseVars = {
            trialMatches: [],
            trialNoMatches: [],
            trialMatchParams: [],
            trialRTs: [],
            trialErrors: []
        }

        // This function controls the overall 'states' of the Auditory Working Memory Task
        //
        // 0 = Main instructions section
        // 1 = Practice instructions
        // 2 = Practice trial
        // 3 = Ready Set before the Main Exp
        // 4 = Main part of the experiment
        // 5 = Segment Break
        //
        // The 'substate' determines the part of 'Practice' or 'MainExp' the participant is in
        //
        //  0 = Countdown
        //  1 = Trial Loop
        //  2 = Debrief
        //
        // The 'trialstate' relates to the part of the trial that the participant is in
        //
        //  0 = Stimulus presentation
        //  1 = Retrocue if needed
        //  2 = Matching Phase
        //
        // The 'errorstate' relates to certain errors related to the Matching part
        //
        //  0 = No errors
        //  1 = No match with mouse prior to pressing Enter
        //

        class awmState {
            constructor(state) {
                this.state = state;
                this.substate = 0;
                this.trialstate = 0;
                this.errorstate = 0;
            };
        }

        // Create AWM Instance Mode and Experimental Conditions (Sound Parameters)
        //
        //  0 is Pure Tone with Load 1
        //  1 is Pure Tone with Load 2
        //  2 is AM Rate with Load 1
        //  3 is AM Rate with Load 2
        //
        let awm;
        function createAWM() {
            awm = new p5(awm_s, 'awm_div');
            //let trialType = 0;

            awmExpVars.progress = (((awmExpVars.trial + 1) / awmExpVars.nTrials) * 100);
            document.getElementById('progressBar').style.width = awmExpVars.progress.toString() + '%';

            for (let j = 0; j < awmExpVars.nTrials / 2; j++) {
                awmExpVars.expOrder.push(0);
                awmExpVars.expOrder.push(2);
            };

            let cueIdx = 0;
            for (let i = 0; i < awmExpVars.nTrials; i++) {
                if (awmExpVars.expOrder[i] == 0) {
                    awmExpVars.expStims1.push(Math.random() * (880 - 440) + 440);
                    awmExpVars.expStims2.push(-1);
                    awmExpVars.expLoad.push(1);
                    awmExpVars.expCues.push(-1);

                } else if (awmExpVars.expOrder[i] == 1) {
                    awmExpVars.expStims1.push(Math.random() * (880 - 440) + 440);
                    if (awmExpVars.expStims1[i] < 660) {
                        awmExpVars.expStims2.push(Math.random() * (880 - 660) + 660);
                    } else {
                        awmExpVars.expStims2.push(Math.random() * (660 - 440) + 440);
                    };
                    awmExpVars.expLoad.push(2);
                    awmExpVars.expCues.push(cues[cueIdx]);
                    cueIdx++;

                } else if (awmExpVars.expOrder[i] == 2) {
                    awmExpVars.expStims1.push(Math.random() * (20 - 5) + 5);
                    awmExpVars.expStims2.push(-1);
                    awmExpVars.expLoad.push(1);
                    awmExpVars.expCues.push(-1);

                } else if (awmExpVars.expOrder[i] == 3) {
                    awmExpVars.expStims1.push(Math.random() * (20 - 5) + 5);
                    if (awmExpVars.expStims1[i] < 11) {
                        awmExpVars.expStims2.push(Math.random() * (20 - 11) + 11);
                    } else {
                        awmExpVars.expStims2.push(Math.random() * (11 - 5) + 5);
                    };
                    awmExpVars.expLoad.push(2);
                    awmExpVars.expCues.push(cues[cueIdx]);
                    cueIdx++;

                };
            };
        }

        // Create the AWM p5js Instance
        let awmIntroVideo, awmButtonReadySet, awmButtonAccept;
        const awm_s = p => {
            // Preload AWM Video file
            p.preload = () => {
                awmIntroVideo = p.createVideo("static/videos/audcog_prevent_am.mp4");
            }

            // Setup p5js Canvas
            p.setup = () => {
                canvas = p.createCanvas(900, 700);
                canvas.mousePressed(awmMousePressed);

                awmIntroVideo.size(800, 500);
                awmIntroVideo.hide();
                awmIntroVideo.volume(1);
                awmIntroVideo.play();

                awmExpHandler = new awmState(0);

                awmButtonInstruct = new Button(p.width / 2, 650, 40, awm);
                awmButtonPracticeInstruct = new Button(p.width / 2, 650, 40, awm);
                awmButtonReadySet = new Button(p.width / 2, 650, 40, awm);
                awmButtonAccept = new Button(p.width / 2, 630, 100, awm);

                p.rectMode(p.CENTER);
                p.imageMode(p.CENTER);

            };

            // Draw p5js Canvas
            p.draw = () => {
                if (audcog.awm) {
                    p.background(255);
                    if (awmExpHandler.state == 0) {
                        awmInstructions(awm);
                    } else if (awmExpHandler.state == 1) {
                        awmPracticeInstructions(awm);
                    } else if (awmExpHandler.state == 2) {
                        awmPracticeTrial(awm);
                    } else if (awmExpHandler.state == 3) {
                        awmReadySet(awm);
                    } else if (awmExpHandler.state == 4) {
                        awmMainExp(awm);
                    } else {
                        awmSegmentBreak(awm);
                    };
                };
            };
        }

        // Function to be executed when mouse is pressed on AWM canvas
        let awmMousePressed = () => {
            if (audcog.awm) {
                if (awmExpHandler.state == 0) {
                    if (awmButtonInstruct.hovering) {
                        awmIntroVideo.pause();
                        awmExpHandler.state = 1;
                        document.getElementById('title_div').innerHTML = "Instructions";
                        flashInstructAlpha = 255;
                    };
                } else if (awmExpHandler.state == 1) {
                    if (awmButtonPracticeInstruct.hovering) {
                        awmExpHandler.state = 2;
                        document.getElementById('title_div').innerHTML = "Practice Trial";
                        flashInstructAlpha = 255;
                    };
                } else if (awmExpHandler.state == 2 || awmExpHandler.state == 4) {
                    if (awmExpVars.clickAllow) {
                        if (awmExpHandler.trialstate == 2) {
                            if (!awmButtonAccept.hovering) {
                                awmExpVars.trialMatches++;
                            };
                            awmExpVars.clickAllow = false;
                            setTimeout(function () {
                                awmExpVars.clickAllow = true;
                            }, 1010);
                            if (awmExpHandler.state == 2 && !awmButtonAccept.hovering) {
                                mouseUpdateMatch(awm, awmExpVars.pracOrder[awmExpVars.trial]);
                            } else if (awmExpHandler.state == 4 && !awmButtonAccept.hovering) {
                                mouseUpdateMatch(awm, awmExpVars.expOrder[awmExpVars.trial]);
                                awmExpVars.trialMatchParams.push(Xtransform);
                            };
                            if (awmButtonAccept.hovering) {
                                if (awmExpVars.trialMatches == 0) {
                                    awmExpHandler.errorstate = 1;
                                    setTimeout(function () {
                                        awmExpHandler.errorstate = 0;
                                    }, 1500);
                                } else {
                                    if (awmExpHandler.state == 2 && awmExpHandler.trialstate == 2) {
                                        awmExpVars.trialMatches = 0;
                                        awmExpVars.trial++;
                                        awmExpHandler.trialstate = 0;
                                        if (awmExpVars.trial == awmExpVars.pracTrials) {
                                            awmExpHandler.state = 3;
                                            awmExpHandler.substate = 0;
                                            awmExpVars.trial = 0;
                                        };
                                        if (awmExpHandler.state == 2) {
                                            setTimeout(function () {
                                                awmPlayTrial(awmExpVars.pracOrder[awmExpVars.trial], awmExpVars.pracLoad[awmExpVars.trial], awmExpVars.pracStims1[awmExpVars.trial], awmExpVars.pracStims2[awmExpVars.trial]);
                                            }, 1500);
                                        };
                                    } else if (awmExpHandler.state == 4 && awmExpHandler.trialstate == 2) {
                                        saveChoices();
                                        awmExpVars.trial++;
                                        awmExpVars.progress = (((awmExpVars.trial + 1) / awmExpVars.nTrials) * 100)
                                        document.getElementById('progressBar').style.width = awmExpVars.progress.toString() + '%';
                                        awmExpHandler.trialstate = 0;
                                        if (awmExpVars.trial == awmExpVars.nTrials) {
                                            calcPrecision(awmExpVars.expOrder, awmExpVars.expStims1, awmExpVars.expStims2, awmExpVars.expCues, awmResponseVars.trialMatches, awmResponseVars.trialErrors);
                                            let date = new Date;
                                            let timeprint = `${("0" + (date.getDate())).slice(-2)}` + `${("0" + (date.getMonth() + 1)).slice(-2)}` + `${date.getFullYear()}` + `${("0" + (date.getHours())).slice(-2)}` + `${("0" + (date.getMinutes())).slice(-2)}`;
                                            timings.awmFinishTime = `${("0" + (date.getHours())).slice(-2)}` + `${("0" + (date.getMinutes())).slice(-2)}`;

                                            taskresults.child(userID).child('awm').child(timeprint).set({
                                                'trialType': awmExpVars.expOrder,
                                                'trialLoad': awmExpVars.expLoad,
                                                'reactionTimes': awmResponseVars.trialRTs,
                                                'trialNoMatches': awmResponseVars.trialNoMatches,
                                                'trialAllMatches': awmResponseVars.trialMatchParams,
                                                'trialMatches': awmResponseVars.trialMatches,
                                                'trialStim1': awmExpVars.expStims1,
                                                'trialStim2': awmExpVars.expStims2,
                                                'trialCues': awmExpVars.expCues,
                                                'awmStartTime': timings.awmStartTime,
                                                'awmFinishTime': timings.awmFinishTime
                                            }).catch(err => {
                                                console.log(err.message);
                                            });
                                            if (userID == 'debug') {
                                                calcPrecision(awmExpVars.expOrder, awmExpVars.expStims1, awmExpVars.expStims2, awmExpVars.expCues, awmResponseVars.trialMatches, awmResponseVars.trialErrors);
                                                displayDebugResults(awmResponseVars.trialErrors, 1);
                                                document.getElementById('resultsChart').style.display = 'block';
                                                document.getElementById('awm_div').style.display = 'none';
                                            } else {
                                                document.getElementById('awm_div').style.display = 'none';
                                                document.getElementById('controller_div').style.display = 'block';
                                                document.getElementById('debrief_div').style.display = 'block';
                                                audcog.awm = false;
                                            };
                                        } else if (awmExpVars.trial == awmExpVars.segTrials) {
                                            awmExpHandler.state = 5;
                                        } else {
                                            setTimeout(function () {
                                                awmPlayTrial(awmExpVars.expOrder[awmExpVars.trial], awmExpVars.expLoad[awmExpVars.trial], awmExpVars.expStims1[awmExpVars.trial], awmExpVars.expStims2[awmExpVars.trial]);
                                            }, 1500);
                                        };
                                    };
                                };
                            };
                        };
                    };
                } else if (awmExpHandler.state == 3) {
                    if (awmButtonReadySet.hovering) {
                        awmExpHandler.state = 4;
                        awmExpVars.segCountdown = 3;
                        awmExpVars.trialMatches = 0;
                        document.getElementById('title_div').innerHTML = "Get Ready";
                        flashInstructAlpha = 255;
                    };
                } else if (awmExpHandler.state == 5) {
                    if (awmButtonReadySet.hovering) {
                        awmExpHandler.state = 4;
                        awmExpHandler.substate = 0;
                        awmExpVars.segCountdown = 3;
                        awmExpVars.trialMatches = 0;
                        document.getElementById('title_div').innerHTML = "Get Ready";
                        flashInstructAlpha = 255;
                    };
                };
            };
        }

        function flashInstruct(rate, p5instance) {
            p5instance.push();
            p5instance.fill(255, flashInstructAlpha);
            p5instance.noStroke();
            p5instance.rectMode(p5instance.CENTER);
            p5instance.rect(p5instance.width / 2, p5instance.height / 2, 900, 700);
            flashInstructAlpha -= rate;
            p5instance.pop();
        }

        function flashPracticeInstruct(p5instance) {
            p5instance.push();
            p5instance.fill(255, flashPracticeInstructAlpha);
            p5instance.noStroke();
            p5instance.rectMode(p5instance.CENTER);
            p5instance.rect(p5instance.width / 2, p5instance.height / 2 - 100, 900, 650);
            // flashPracticeInstructAlpha -= Math.pow(Math.E, 1/flashPracticeInstructAlpha);
            p5instance.stroke(0);
            p5instance.fill(0, 50, 200, 200);
            p5instance.triangle(265, 650, 255, 620, 275, 620);
            p5instance.triangle(450, 650, 440, 620, 460, 620);
            p5instance.triangle(650, 650, 640, 620, 660, 620);
            p5instance.pop();
        }

        let awmButtonInstruct, awmButtonPracticeInstruct;
        function awmInstructions(p5instance) {
            awm.imageMode(awm.CENTER);
            let img = awmIntroVideo.get();
            awm.image(img, p5instance.width / 2, p5instance.height / 2);
            p5instance.textSize(25);
            p5instance.fill(50);
            p5instance.textAlign(p5instance.CENTER);
            p5instance.text("Click below after the video", p5instance.width / 2, 580);
            awmButtonInstruct.show(p5instance);
            awmButtonInstruct.hover(p5instance.mouseX, p5instance.mouseY, p5instance);
            flashInstruct(flashInstructFadeRate, awm);
        }

        function awmPracticeInstructions(p5instance) {
            let s = 'In this practice session, you will attempt 4 trials\n\nYou will either hear a tone or a sound like a moving train\n\nYou have to find that sound on the grey line';
            p5instance.fill(0, 150);
            p5instance.textSize(30);
            p5instance.textFont('Georgia');
            p5instance.textAlign(p5instance.CENTER, p5instance.CENTER);
            p5instance.text(s, p5instance.width / 2, p5instance.height / 2 - 50);
            p5instance.textSize(25);
            p5instance.fill(50);
            p5instance.text("Start Practice by clicking below", p5instance.width / 2, 580);
            awmButtonPracticeInstruct.show(p5instance);
            awmButtonPracticeInstruct.hover(p5instance.mouseX, p5instance.mouseY, p5instance);
            awmFlashInstruct(flashInstructFadeRate, awm);
        }

        function awmFlashInstruct(rate, p5instance) {
            p5instance.push();
            p5instance.fill(255, flashInstructAlpha);
            p5instance.noStroke();
            p5instance.rectMode(p5instance.CENTER);
            p5instance.rect(p5instance.width / 2, p5instance.height / 2, 900, 700);
            flashInstructAlpha -= rate;
            p5instance.pop();
        }

        function awmFlashPracticeInstruct(p5instance) {
            p5instance.push();
            p5instance.fill(255, flashPracticeInstructAlpha);
            p5instance.noStroke();
            p5instance.rectMode(p5instance.CENTER);
            p5instance.rect(p5instance.width / 2, p5instance.height / 2 - 100, 900, 650);
            // flashPracticeInstructAlpha -= Math.pow(Math.E, 1/flashPracticeInstructAlpha);
            p5instance.stroke(0);
            p5instance.fill(0, 50, 200, 200);
            p5instance.triangle(265, 650, 255, 620, 275, 620);
            p5instance.triangle(450, 650, 440, 620, 460, 620);
            p5instance.triangle(650, 650, 640, 620, 660, 620);
            p5instance.pop();
        }

        function awmPracticeTrial(p5instance) {
            if (awmExpHandler.substate == 0) {
                Count2Start(p5instance);
            } else if (awmExpHandler.substate == 1) {
                awmExpTrial(p5instance);
            } else if (awmExpHandler.substate == 2) {
                awmPracticeOver(p5instance);
            };
        }

        function awmReadySet(p5instance) {
            let s = 'Now you will begin the actual task\n\nIt will take around 3 mins\n\nTry your best to remember the sounds\n\n\nGuess when you are not sure!';
            p5instance.fill(0, 150);
            p5instance.textSize(30);
            p5instance.textFont('Georgia');
            p5instance.textAlign(p5instance.CENTER, p5instance.CENTER);
            p5instance.text(s, p5instance.width / 2, p5instance.height / 2 - 50);
            p5instance.textSize(25);
            p5instance.fill(50);
            p5instance.text('Start Main Task by clicking below', p5instance.width / 2, 560);
            awmButtonReadySet.show(p5instance);
            awmButtonReadySet.hover(p5instance.mouseX, p5instance.mouseY, p5instance);
            flashInstruct(flashInstructFadeRate, awm);
        }

        function awmSegmentBreak(p5instance) {
            let s = 'Have a little break\n\n\n\nThen click below to continue the task';
            p5instance.fill(0, 150);
            p5instance.textSize(30);
            p5instance.textFont('Georgia');
            p5instance.textAlign(p5instance.CENTER, p5instance.CENTER);
            p5instance.text(s, p5instance.width / 2, p5instance.height / 2 - 50);
            p5instance.textSize(25);
            p5instance.fill(50);
            p5instance.text('Continue by clicking below', p5instance.width / 2, 560);
            awmButtonReadySet.show(p5instance);
            awmButtonReadySet.hover(p5instance.mouseX, p5instance.mouseY, p5instance);
            flashInstruct(flashInstructFadeRate, awm);
        }

        function awmMainExp(p5instance) {
            if (awmExpHandler.substate == 0) {
                Count2Start(p5instance);
            } else if (awmExpHandler.substate == 1) {
                awmExpTrial(p5instance);
            } else if (awmExpHandler.substate == 2) {
                awmTaskOver(p5instance);
            };
        }

        function Count2Start(p5instance) {
            if (p5instance.frameCount % 60 == 0) {
                awmExpVars.segCountdown--;
            };
            p5instance.textAlign(p5instance.CENTER, p5instance.CENTER);
            p5instance.textSize(100);
            if (awmExpVars.segCountdown == 0) {
                awmExpHandler.substate = 1;

                date = new Date;
                timings.awmStartTime = `${("0" + (date.getHours())).slice(-2)}` + `${("0" + (date.getMinutes())).slice(-2)}`;

                if (awmExpHandler.state == 2) {
                    setTimeout(function () {
                        awmPlayTrial(awmExpVars.pracOrder[awmExpVars.trial], awmExpVars.pracLoad[awmExpVars.trial], awmExpVars.pracStims1[awmExpVars.trial], awmExpVars.pracStims2[awmExpVars.trial]);
                    }, 1500);
                } else if (awmExpHandler.state == 4) {
                    setTimeout(function () {
                        awmPlayTrial(awmExpVars.expOrder[awmExpVars.trial], awmExpVars.expLoad[awmExpVars.trial], awmExpVars.expStims1[awmExpVars.trial], awmExpVars.expStims2[awmExpVars.trial]);
                    }, 1500);
                };
            } else {
                p5instance.fill(0);
                p5instance.text(awmExpVars.segCountdown, p5instance.width / 2, p5instance.height / 2);
            };
        }

        // Playing the Auditory Stimulus and Probe in each trial after the trialUpdate..() functions are performed
        function playSound(trialtype, param) {
            if (trialtype == 0 || trialtype == 1) {
                //Pure Tone
                let tone = new p5.Oscillator('sine');
                let env = new p5.Envelope();
                env.setADSR(0.01, 0.95, 0.1, 0.01)
                tone.amp(env);
                tone.freq(param);
                tone.start();
                env.play();
                setTimeout(function () {
                    tone.stop();
                }, 1000);
            } else if (trialtype == 2 || trialtype == 3) {
                //AM Noise
                mod = new p5.Oscillator('sine');
                mod.freq(param);
                mod.disconnect();
                mod.start();
                noise = new p5.Noise('brown');
                noise.amp(mod, 0.1);
                noise.start();
                setTimeout(function () {
                    mod.stop();
                    noise.stop();
                }, 1000);
            };
        }

        // Function to Play an AWM Trial
        function awmPlayTrial(trialtype, load, param1, param2) {
            if (load == 1) {
                playSound(trialtype, param1);
                setTimeout(function () {
                    //audMasker(awm);
                    awmExpHandler.trialstate = 2;
                }, 2000);
            } else if (load == 2) {
                playSound(trialtype, param1);
                setTimeout(function () {
                    playSound(trialtype, param2);
                    setTimeout(function () {
                        //audMasker(awm);
                        awmExpHandler.trialstate = 2;
                    }, 2000);
                }, 2000);
            };
        }

        // This function prompts the user to Click on the slider to choose an answer before pressing Enter
        function clickPrompt(p5instance) {
            p5instance.push();
            p5instance.fill(0, 150);
            p5instance.textSize(30);
            p5instance.text('LEFT-CLICK to make a CHOICE with your MOUSE', p5instance.width / 2, p5instance.height / 2 * 2 / 3);
            p5instance.pop();
        }

        // Updates the location of the Red Marker above the slider when the Probe is initially displayed and a Match is made
        function markerUpdate(p5instance) {
            p5instance.push();
            p5instance.strokeWeight(2);
            p5instance.stroke(125, 0, 0);
            p5instance.fill('red');
            p5instance.triangle(p5instance.constrain(sliderX, 100, 900), p5instance.height / 2 - 60, sliderX - 10, p5instance.height / 2 - 75, sliderX + 10, p5instance.height / 2 - 75);
            p5instance.pop();
        }

        // Display the Slider on the screen as a long rectangle
        function displaySlider(p5instance) {
            p5instance.push();
            p5instance.stroke(200);
            p5instance.fill(150, 50);
            p5instance.rect(p5instance.width / 2, p5instance.height / 2, 800, 20, 10, 10, 10, 10);
            p5instance.pop();
        }

        // Update marker on the scale during Matching Phase and play corresponding sound
        function mouseUpdateMatch(p5instance, trialType) {
            sliderX = p5instance.mouseX;
            if (trialType == 0 || trialType == 1) {
                Xtransform = p5instance.map(p5instance.mouseX, 200, 800, 440, 880);
                console.log('sound parameter match is ... ' + Xtransform);
                playSound(trialType, Xtransform);
            } else if (trialType == 2 || trialType == 3) {
                Xtransform = p5instance.map(p5instance.mouseX, 200, 800, 5, 20);
                console.log('sound parameter match is ... ' + Xtransform);
                playSound(trialType, Xtransform);
                //no protect
            };
        }

        // Main Trial Loop - Step by Step Comments in Place
        function awmExpTrial(p5instance) {
            // Trial Stimulus
            if (awmExpHandler.trialstate == 0) {
                p5instance.push();
                p5instance.fill(0, 100);
                p5instance.textSize(40);
                p5instance.text('Listen Carefully', p5instance.width / 2, p5instance.height / 2 - 40);
                p5instance.pop();
                // Matching part of trial
            } else if (awmExpHandler.trialstate == 1) {
                p5instance.push();
                p5instance.fill(0, 100);
                p5instance.textSize(40);
                if (awmExpHandler.state == 2) {
                    if (awmExpVars.pracLoad[awmExpVars.trial] == 2) {
                        p5instance.text('Remember sound', p5instance.width / 2, p5instance.height / 2 - 40);
                        p5instance.text(awmExpVars.pracCues[awmExpVars.trial] + 1, p5instance.width / 2, p5instance.height / 2);
                    };
                } else if (awmExpHandler.state = 4) {
                    if (awmExpVars.expLoad[awmExpVars.trial] == 2) {
                        p5instance.text('Remember sound', p5instance.width / 2, p5instance.height / 2 - 40);
                        p5instance.text(awmExpVars.expCues[awmExpVars.trial] + 1, p5instance.width / 2, p5instance.height / 2);
                    };
                };
                p5instance.pop();
                // Matching part of trial
            } else if (awmExpHandler.trialstate == 2) {
                awmExpVars.trialRT = p5instance.millis();
                document.body.style.cursor = 'default';
                if (awmExpVars.trialMatches != 0) {
                    markerUpdate(awm);
                };
                displaySlider(awm);
                if (awmExpHandler.errorstate == 1) {
                    clickPrompt(awm);
                };
                p5instance.push();
                p5instance.fill(0, 100);
                p5instance.textSize(40);
                p5instance.text('Find the SOUND on the line below with the mouse', p5instance.width / 2, p5instance.height / 5);
                p5instance.text('Press the BUTTON below for the next trial', p5instance.width / 2, p5instance.height * 3.5 / 5);
                awmButtonAccept.show(p5instance);
                awmButtonAccept.hover(p5instance.mouseX, p5instance.mouseY, p5instance);
                p5instance.fill(10, 225);
                p5instance.rect(p5instance.constrain(p5instance.mouseX, 100, 900), p5instance.height / 2, 10, 50, 20, 20, 20, 20);
                p5instance.pop();
            };
        }

        // Append trial parameters and choices into the master 'exp' list
        function saveChoices() {
            awmResponseVars.trialRTs.push(awm.millis() - awmExpVars.trialRT);
            awmResponseVars.trialMatches.push(Xtransform);
            awmResponseVars.trialNoMatches.push(awmExpVars.trialMatches);
            awmExpVars.trialMatches = 0;
            awmResponseVars.trialMatchParams.push(awmExpVars.trialMatchParams);
            awmExpVars.trialMatchParams = [];
        }

        function awmPracticeOver(p5instance) {
            if (progress.expEnd) {
                document.body.style.cursor = 'default';
                p5instance.fill(200);
                p5instance.stroke(0, 125);
                p5instance.strokeWeight(2);
                p5instance.rect(p5instance.width / 2, p5instance.height / 2 + 50, 550, 275, 50);
                p5instance.textAlign(p5instance.CENTER, p5instance.CENTER);
                p5instance.textSize(40);
                p5instance.noStroke();
                p5instance.fill(100);
                p5instance.text("Click Below for the Main Experiment", p5instance.width / 2, p5instance.height / 4);
                p5instance.textAlign(p5instance.LEFT);
                outrobutton1 = new IntroButton(p5instance.width / 3.2, p5instance.height / 2 + 40, 60);
                outrobutton1.show(awm);
                progress.hoverOption[1] = hoverbutton(outrobutton1.x, outrobutton1.y, outrobutton1.rad, progress.hoverOption[1], false);
                p5instance.textFont('Arial');
                p5instance.noStroke();
                p5instance.fill(50);
                if (!progress.hoverOption[1]) {
                    p5instance.textSize(20);
                    p5instance.fill(0, 100);
                    p5instance.text('Click Here', p5instance.width / 2.5, p5instance.height / 2 + 40);
                } else {
                    p5instance.textSize(22);
                    p5instance.fill(0, 200);
                    p5instance.text('Click Here', p5instance.width / 2.5, p5instance.height / 2 + 40);
                };
            };
        }

        function awmTaskOver(p5instance) {
            if (progress.expEnd) {
                document.body.style.cursor = 'default';
                p5instance.fill(200);
                p5instance.stroke(0, 125);
                p5instance.strokeWeight(2);
                p5instance.rect(p5instance.width / 2, p5instance.height / 2 + 50, 550, 275, 50);
                p5instance.textAlign(p5instance.CENTER, p5instance.CENTER);
                p5instance.textSize(40);
                p5instance.noStroke();
                p5instance.fill(100);
                p5instance.text("Thank you for your time!", p5instance.width / 2, p5instance.height / 4);
                p5instance.textAlign(p5instance.LEFT);
                outrobutton1 = new IntroButton(p5instance.width / 3.2, p5instance.height / 2 + 40, 60);
                outrobutton1.show(awm);
                progress.hoverOption[1] = hoverbutton(outrobutton1.x, outrobutton1.y, outrobutton1.rad, progress.hoverOption[1], false);
                p5instance.textFont('Arial');
                p5instance.noStroke();
                p5instance.fill(50);
                if (!progress.hoverOption[1]) {
                    p5instance.textSize(20);
                    p5instance.fill(0, 100);
                    p5instance.text('Click Here', p5instance.width / 2.5, p5instance.height / 2 + 40);
                } else {
                    p5instance.textSize(22);
                    p5instance.fill(0, 200);
                    p5instance.text('Click Here', p5instance.width / 2.5, p5instance.height / 2 + 40);
                };
            };
        }

        let precisionFreqLoad1, precisionFreqLoad2, precisionAMLoad1, precisionAMLoad2;
        let FreqLoad1errors = [], FreqLoad2errors = [], AMLoad1errors = [], AMLoad2errors = [];
        function calcPrecision(expOrder, expStims1, expStims2, expCues, trialMatches, errorsAll) {
            let error;
            for (let i = 0; i < awmExpVars.nTrials; i++) {
                if (expOrder[i] == 0) {
                    error = (Math.log(expStims1[i]) - Math.log(trialMatches[i])) / Math.log(expStims1[i]);
                    errorsAll.push(error * 100);
                    FreqLoad1errors.push(error * 100);
                } else if (expOrder[i] == 1) {
                    if (expCues[i] == 0) {
                        error = (Math.log(expStims1[i]) - Math.log(trialMatches[i])) / Math.log(expStims1[i]);
                    } else {
                        error = (Math.log(expStims2[i]) - Math.log(trialMatches[i])) / Math.log(expStims2[i]);
                    };
                    errorsAll.push(error * 100);
                    FreqLoad2errors.push(error * 100);
                } else if (expOrder[i] == 2) {
                    error = (Math.log(expStims1[i]) - Math.log(trialMatches[i])) / Math.log(expStims1[i]);
                    errorsAll.push(error * 100);
                    AMLoad1errors.push(error * 100);
                } else if (expOrder[i] == 3) {
                    if (expCues[i] == 0) {
                        error = (Math.log(expStims1[i]) - Math.log(trialMatches[i])) / Math.log(expStims1[i]);
                    } else {
                        error = (Math.log(expStims2[i]) - Math.log(trialMatches[i])) / Math.log(expStims2[i]);
                    };
                    errorsAll.push(error * 100);
                    AMLoad2errors.push(error * 100);
                };
            };

            precisionFreqLoad1 = 1 / ss.standardDeviation(FreqLoad1errors);
            //precisionFreqLoad2 = 1/ss.standardDeviation(FreqLoad2errors);
            precisionAMLoad1 = 1 / ss.standardDeviation(AMLoad1errors);
            //precisionAMLoad2 = 1/ss.standardDeviation(AMLoad2errors);
        }

    </script>

</body>

</html>