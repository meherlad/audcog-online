<html>

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
        integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="static/main.css">

    <title> AudCog - Great Minds </title>

</head>

<body>
    <header class="site-header">
        <nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top" id="audcog_header">
            <div class="container">
                <a class="navbar-brand mx-auto" href="/"> AudCog: Great
                    Minds</a>
            </div>
        </nav>
    </header>

    <main role="main" class="container-fluid py-2">
        <div class="row justify-content-center">
            <div class="col">
            </div>

            <!-- Appearances of all divs in this container are run by main.js -->
            <div class="col-md-12">

                <!-- Title Div is shown to guide a participant through task -->
                <div class="content-section text-center font-weight-bold border-0 h3" id="title_div">
                </div>

                <div class="progress" style="height: 30px;">
                    <div class="progress-bar progress-bar-striped bg-info" id=progressBar role="progressbar"
                        style="width: 0%" aria-valuemin="0" aria-valuemax="100"></div>
                </div>

                <!-- This Error Div comes up if the browser is not Chrome or the Screen is less than 1000 pixels wide and 500 pixels high -->
                <div class="content-section" id="browser_device_error" style='display:none'>
                    <p> This device or browser is not supported OR </p>
                    <p> Your screen is too small </p>
                    <p> Please use Google Chrome on a Desktop or Laptop computer </p>
                    <p> Try maximizing your browser window and refresh the webpage </p>
                </div>

                <div class="content-section" id="id_error" style='display:none'>
                    <p> Your ID is not registered to take part </p>
                    <p> Or there is an error in the way it is entered </p>
                    <p> </p>
                    <p> Please contact
                        <span class="font-weight-bold">audcog@ncl.ac.uk
                        </span>for more information
                    </p>
                </div>

                <!-- Login Page is shown when someone first encounters the website -->
                <div class="content-section text-center border-0 p-5" id="login_div">
                    <h6 class="text-dark font-weight-normal py-2"> Press the <span class="font-weight-bold"> 'START'
                        </span>button below to <span class="font-weight-bold">Begin </span></h5>
                        <div>
                            <div class='p-2'>
                                <button id='submitbutton' class="btn btn-dark border-dark font-weight-bold py-2"
                                    type='button'> START </button>
                            </div>
                        </div>
                        <div class="text-center">
                            <input id='dashPassword' type='text' class='p-4' style='visibility:hidden'>
                        </div>
                        <div class="text-danger font-weight-bold p-2">
                            <a id="error_message"> </a>
                        </div>
                        <h6 class="text-danger font-weight-normal"> <span class="font-weight-bold"> WARNING: </span> Do
                            not use Safari as a web browser. Remember to use Headphones too! </h5>
                </div>

                <!-- Controller Div is shown when an experimenter wants to test a task -->
                <div class="content-section text-center border-0" id="controller_div" style='display:none'>
                    <div class="form-group" id="debrief_div" style='display:none'>
                        <div class="col m-3 p-3 border border-secondary rounded bg-light">
                            <h5 class="text-muted p-2"> Thank you for participating in the AudCog study. </h5>
                            <h5 class="text-muted p-2"> You contribution will help us understand the link between
                                hearing ability and risk for dementia. </h5>
                            <h5 class="text-muted p-2"> As mentioned previously, these were research tests only so we do
                                not provide any feedback on performance. </h5>
                            <hr>
                            <h5 class="text-muted p-2"> You are eligible for a Â£50 Amazon voucher </h5>
                            <h6 class="text-muted font-weight-light p-2"> If you would like to be entered into a draw
                                for this, please email the
                                address below </h6>
                            <h6 class="text-muted font-weight-normal p-2"> audcog@ncl.ac.uk </h6>
                        </div>
                        <h5 class="text-dark font-weight-normal p-1"> You may now close this window </h5>
                    </div>
                </div>

                <!-- Speech In Babble Task Div is shown when begins the task run on awm.js -->
                <div class="content-section text-center border-0" id="sib_div" style='display:none'>
                </div>

            </div>
        </div>
    </main>

    <!-- Optional JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/p5@1.4.0/lib/p5.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/addons/p5.sound.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.8.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.8.1/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.8.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.8.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/7.1.0/math.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script src='https://unpkg.com/simple-statistics@7.7.0/dist/simple-statistics.min.js'></script>
    <script src="https://cdn.plot.ly/plotly-2.6.3.min.js"></script>

    <script>
        // Login to Firebase Database
        let userID, database, taskresults;
        window.addEventListener('DOMContentLoaded', (event) => {
            console.log('DOM fully loaded and parsed');
            // Browser and device checks
            const isChrome = /chrome/.test(navigator.userAgent.toLowerCase());
            const isSuitable = true; //(window.innerWidth > 400) && (window.innerHeight > 200)

            // Doesn't have to be Chrome for the time being
            if (isSuitable) {

                userID = getUserIDFromQueryString();

                if (!userID) { // Check if userID is null or empty
                    document.getElementById('login_div').style.display = 'none';
                    document.getElementById('id_error').style.display = 'block';
                }


                // Your web app's Firebase configuration
                const firebaseConfig = {
                    apiKey: "AIzaSyDPTy_twUrqEXlVfpALoqYkPdcux7klcEQ",
                    authDomain: "audcog-online.firebaseapp.com",
                    databaseURL: "https://audcog-online-default-rtdb.europe-west1.firebasedatabase.app",
                    projectId: "audcog-online",
                    storageBucket: "audcog-online.appspot.com",
                    messagingSenderId: "652871235053",
                    appId: "1:652871235053:web:7776007488c3ccf30163e4",
                    measurementId: "G-PCY56CPWHB"
                };
                // Initialize Firebase
                firebase.initializeApp(firebaseConfig);
                firebase.analytics();
                database = firebase.database();
                taskresults = database.ref('audcog-online');
                auth = firebase.auth();

            } else {
                login_div.style.display = 'none';
                browser_device_error_div.style.display = 'block';
            };
        });

        // Authenticate User and Create global variables needed to store in Database
        let database_uid, allVisits, userVisits;

        // Function to extract userID from the query string
        function getUserIDFromQueryString() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('userID');
        }

        document.getElementById('submitbutton').addEventListener('click', function () {
            login_div.style.display = 'none';
            document.getElementById('sib_div').style.display = 'block';
            createSIB();
        });

        // This script includes code for controlling the state of the Experimental workflow
        //
        // In debugging mode, a p5js canvas displays buttons that allow a user to test each task
        // 
        // In experimental mode, the user is taken directly to a set of general instructions and progresses to each task
        //
        let date = new Date;
        let timings = {
            expStartTime: `${("0" + (date.getHours())).slice(-2)}` + `${("0" + (date.getMinutes())).slice(-2)}`,
            expFinishTime: 0,
            awmStartTime: 0,
            awmFinishTime: 0,
        };

        // Generic Classes and Functions

        class Button {
            constructor(locX, locY, rad, p5instance) {
                this.x = locX;
                this.y = locY;
                this.rad = rad;
                this.hovering = false;
                this.p5instance = p5instance;
            };
            show(p5instance) {
                p5instance.push();
                p5instance.fill(255, 255, 255, 150);
                p5instance.stroke(100);
                p5instance.strokeWeight(1);
                p5instance.circle(this.x, this.y, this.rad);
                p5instance.pop();
            };
            hover(px, py, p5instance) {
                if (p5instance.dist(px, py, this.x, this.y) < this.rad / 2) {
                    p5instance.push();
                    p5instance.fill('red');
                    p5instance.stroke(100);
                    p5instance.strokeWeight(3);
                    p5instance.circle(this.x, this.y, this.rad + 10);
                    this.hovering = true;
                    p5instance.pop();
                } else {
                    this.hovering = false;
                };
            };
        }

        // All clickable buttons with words, during the response phase, are produced with this class
        class choiceBox {
            constructor(x, y, text) {
                this.x = x;
                this.y = y;
                this.width = 100;
                this.height = 50;
                this.textSize = 20
                this.text = text;
                this.over = false;
                this.pressed = false;
                this.fillVal = 225;
            }

            show(p5instance) {
                p5instance.push();
                p5instance.fill(this.fillVal);
                p5instance.rectMode(p5instance.CENTER);
                p5instance.rect(this.x, this.y, this.width, this.height, 10);
                p5instance.fill(0);
                p5instance.textSize(this.textSize);
                p5instance.textAlign(p5instance.CENTER, p5instance.CENTER);
                p5instance.text(this.text, this.x, this.y);
                p5instance.strokeWeight(2);
                p5instance.stroke(255);
                p5instance.pop();
            }

            mouseisover(px, py) {
                if (this.pressed == false) {
                    if ((Math.abs(this.x - px) < this.width / 2) && (Math.abs(this.y - py) < this.height / 2)) {
                        this.fillVal = 200;
                        this.over = true;
                    } else {
                        this.fillVal = 225;
                        this.over = false;
                    };
                } else {
                    if ((Math.abs(this.x - px) < this.width / 2) && (Math.abs(this.y - py) < this.height / 2)) {
                        this.fillVal = 100;
                        this.over = true;
                    } else {
                        this.fillVal = 125;
                        this.over = false;
                    };
                };
            }

            clicked() {
                this.fillVal = 125;
                this.pressed = true;
            }
        }

        class playButton {
            constructor(locX1, locX2, locY1, locY2, locZ1, locZ2) {
                this.x1 = locX1;
                this.y1 = locY1;
                this.z1 = locZ1;
                this.x2 = locX2;
                this.y2 = locY2;
                this.z2 = locZ2;
                this.hovering = false;
                this.pressed = false;
                this.fillVal = 'red';
            };
            show(p5instance) {
                p5instance.push();
                p5instance.fill('white');
                p5instance.rect(this.x1 + 25, this.z2, 100, 80);
                p5instance.fill(this.fillVal);
                if (!this.pressed) {
                    p5instance.triangle(this.x1, this.x2, this.y1, this.y2, this.z1, this.z2);
                } else {
                    p5instance.rect(this.x1 + 10, this.z2, 20, 60);
                    p5instance.rect(this.x1 + 40, this.z2, 20, 60);
                };
                p5instance.pop();
            };
            hover(px, py, p5instance) {
                if (p5instance.dist(px, py, this.z1 - 25, this.z2) < 50) {
                    p5instance.push();
                    p5instance.fill('grey');
                    p5instance.rect(this.x1 + 25, this.z2, 100, 80);
                    p5instance.fill(this.fillVal);
                    if (!this.pressed) {
                        p5instance.triangle(this.x1, this.x2, this.y1, this.y2, this.z1, this.z2);
                    } else {
                        p5instance.rect(this.x1 + 10, this.z2, 20, 60);
                        p5instance.rect(this.x1 + 40, this.z2, 20, 60);
                    };
                    p5instance.pop();
                    this.hovering = true;
                } else {
                    this.hovering = false;
                };
            };
            clicked() {
                this.pressed = !this.pressed;
                if (this.pressed) {
                    this.fillVal = 'green';
                } else {
                    this.fillVal = 'red';
                };
            };
        }

        // Global Experimental Variables

        // audcog controls event handlers for each task
        let audcog = {
            sib: true,
        }

        // Some Helper Functions
        //
        // Shuffle array function
        function shuffle(array) {
            let currentIndex = array.length, randomIndex;
            // While there remain elements to shuffle
            while (currentIndex != 0) {
                // Pick a remaining element
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                // And swap it with the current element
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            };
            return array;
        }

        // Create evently spaced values from startValue to stopValue
        function linSpace(startValue, stopValue, cardinality) {
            var arr = [];
            var step = (stopValue - startValue) / (cardinality - 1);
            for (var i = 0; i < cardinality; i++) {
                arr.push(startValue + (step * i));
            }
            return arr;
        }

        let flashInstructAlpha = 255; let flashPracticeInstructAlpha = 255; let flashInstructFadeRate = 5;

        // 
        // Speech in Babble Task - Holmes and Griffiths. Sci Reports. 2019
        //
        // This task tests speech in babble perception using an adaptive 1-up, 1-down paradigm
        // 50% thresholds are calculated using a mean of the last 6 reversals (task stops after 10 reversals)
        // Sentences consist of 5 words of the structure <NAME><VERB><NUMBER><ADJ><NOUN> on a background of 3 talkers
        // Speakers talk in English with a Southern English accent
        //
        // Created by Meher Lad - July 2021
        //

        let randBabbleNumber;

        let textBox = [];
        let sentenceChoice = "";

        let sibExpHandler;
        let sampleCount = 0;

        let samplePracticeList = [Math.floor(Math.random() * 144), Math.floor(Math.random() * 144) + 144];
        let samplePracticeResp = [0, 0];

        let sentenceList = []; let sentenceFile; let wordList = []; let preWordList = [];
        let sentenceRandIdx = []; let sentenceVerdict = []; let sibTrialVols = [];
        let sentenceIdx;
        let sibStartTrialVolume = 20; let sibTrialVolume = sibStartTrialVolume;
        let sibVolSteps = [5, 2, 1]; let sibReversals = 0; let sibRevVols = [];
        let sibThreshold;
        let sibRTs = []; let sibTrialRT = 0;

        let sibPracStimPlayed = false;
        let sibClickAllow = true;
        let sibProgress = 0;
        let sibTrialPresses = [0, 0, 0, 0, 0];

        // This function controls the state of the Speech-in-Noise Task
        //
        // 0 brings a participant to the main instructions section
        // 1 to the practice instructions
        // 2 to the practice trial
        // 3 to the main part of the experiment
        //
        class sibState {
            constructor(state) {
                this.state = state;
            }
        }

        // What happens when then mouse is pressed in the SIB instance
        var sibMousePressed = () => {
            if (audcog.sib) {
                if (sibExpHandler.state == 0) {
                    if (buttonInstruct.hovering == true) {
                        sibExpHandler.state = 1;
                        sibIntroVideo.pause();
                        document.getElementById('title_div').innerHTML = "Instructions";
                        flashInstructAlpha = 255;
                    };
                } else if (sibExpHandler.state == 1) {
                    if (buttonPracticeInstruct.hovering == true) {
                        sibExpHandler.state = 2;
                        document.getElementById('title_div').innerHTML = "Practice - Sample 1";
                        flashInstructAlpha = 255;
                    };
                } else if ((sibExpHandler.state == 2) || (sibExpHandler.state == 3) || (sibExpHandler.state == 4)) {
                    var wordCount = 0;
                    for (var i = 0; i < 5; i++) {
                        if ((textBox[wordCount].over == true) && (textBox[wordCount].pressed != true)) {
                            textBox[wordCount].clicked(); sibTrialPresses[i] = 1;
                            for (var j = wordCount; j < wordCount + 10; j++) {
                                if (j != wordCount) {
                                    textBox[j].pressed = false;
                                };
                            };
                        } else if ((textBox[wordCount + 1].over == true) && (textBox[wordCount + 1].pressed != true)) {
                            textBox[wordCount + 1].clicked(); sibTrialPresses[i] = 1;
                            for (var j = wordCount; j < wordCount + 10; j++) {
                                if (j != wordCount + 1) {
                                    textBox[j].pressed = false;
                                };
                            };
                        } else if ((textBox[wordCount + 2].over == true) && (textBox[wordCount + 2].pressed != true)) {
                            textBox[wordCount + 2].clicked(); sibTrialPresses[i] = 1;
                            for (var j = wordCount; j < wordCount + 10; j++) {
                                if (j != wordCount + 2) {
                                    textBox[j].pressed = false;
                                };
                            };
                        } else if ((textBox[wordCount + 3].over == true) && (textBox[wordCount + 3].pressed != true)) {
                            textBox[wordCount + 3].clicked(); sibTrialPresses[i] = 1;
                            for (var j = wordCount; j < wordCount + 10; j++) {
                                if (j != wordCount + 3) {
                                    textBox[j].pressed = false;
                                };
                            };
                        } else if ((textBox[wordCount + 4].over == true) && (textBox[wordCount + 4].pressed != true)) {
                            textBox[wordCount + 4].clicked(); sibTrialPresses[i] = 1;
                            for (var j = wordCount; j < wordCount + 10; j++) {
                                if (j != wordCount + 4) {
                                    textBox[j].pressed = false;
                                };
                            };
                        } else if ((textBox[wordCount + 5].over == true) && (textBox[wordCount + 5].pressed != true)) {
                            textBox[wordCount + 5].clicked(); sibTrialPresses[i] = 1;
                            for (var j = wordCount; j < wordCount + 10; j++) {
                                if (j != wordCount + 5) {
                                    textBox[j].pressed = false;
                                };
                            };
                        } else if ((textBox[wordCount + 6].over == true) && (textBox[wordCount + 6].pressed != true)) {
                            textBox[wordCount + 6].clicked(); sibTrialPresses[i] = 1;
                            for (var j = wordCount; j < wordCount + 10; j++) {
                                if (j != wordCount + 6) {
                                    textBox[j].pressed = false;
                                };
                            };
                        } else if ((textBox[wordCount + 7].over == true) && (textBox[wordCount + 7].pressed != true)) {
                            textBox[wordCount + 7].clicked(); sibTrialPresses[i] = 1;
                            for (var j = wordCount; j < wordCount + 10; j++) {
                                if (j != wordCount + 7) {
                                    textBox[j].pressed = false;
                                };
                            };
                        } else if ((textBox[wordCount + 8].over == true) && (textBox[wordCount + 8].pressed != true)) {
                            textBox[wordCount + 8].clicked(); sibTrialPresses[i] = 1;
                            for (var j = wordCount; j < wordCount + 10; j++) {
                                if (j != wordCount + 8) {
                                    textBox[j].pressed = false;
                                };
                            };
                        } else if ((textBox[wordCount + 9].over == true) && (textBox[wordCount + 9].pressed != true)) {
                            textBox[wordCount + 9].clicked(); sibTrialPresses[i] = 1;
                            for (var j = wordCount; j < wordCount + 10; j++) {
                                if (j != (wordCount + 9)) {
                                    textBox[j].pressed = false;
                                };
                            };
                        };
                        wordCount = wordCount + 10;
                    };
                    if (sibExpHandler.state == 2) {
                        if (buttonPracticeRepeat.hovering == true) {
                            if (sibClickAllow) {
                                sibClickAllow = false;
                                buttonPracticeRepeat.hovering = false;
                                playTrial(samplePracticeList[sampleCount]);
                                sibTrialPlay = true;
                                setTimeout(function () {
                                    sibClickAllow = true;
                                }, 4000);
                            };
                        };
                        if (buttonPracticeNext.hovering == true) {
                            buttonPracticeNext.hovering = false;
                            evalWordChoices();
                            setTimeout(function () {
                                if (samplePracticeResp[sampleCount] == 1) {
                                    document.getElementById('title_div').innerHTML = "Practice - Sample 2";
                                    sampleCount++;
                                    for (var i = 0; i < textBox.length; i++) {
                                        textBox[i].fillVal = 225;
                                        textBox[i].pressed = false;
                                    };
                                    if (sampleCount == 2) {
                                        sibExpHandler.state = 3;
                                        flashInstructAlpha = 255;
                                    };
                                } else {
                                    document.getElementById('title_div').innerHTML = "Try Again";
                                    for (var i = 0; i < textBox.length; i++) {
                                        textBox[i].fillVal = 225;
                                        textBox[i].pressed = false;
                                    };
                                    setTimeout(function () {
                                        document.getElementById('title_div').innerHTML = "Practice";
                                    }, 1500);
                                };
                                sibTrialPlay = false;
                            }, 1500)
                        };
                    } else if (sibExpHandler.state == 3) {
                        if (buttonReadySet.hovering == true) {
                            buttonReadySet.hovering = false;

                            date = new Date;
                            timings.sibStartTime = `${("0" + (date.getHours())).slice(-2)}` + `${("0" + (date.getMinutes())).slice(-2)}`;

                            for (var i = 0; i < textBox.length; i++) {
                                textBox[i].fillVal = 225;
                                textBox[i].pressed = false;
                            };
                            sibExpHandler.state = 4;
                            document.getElementById('title_div').innerHTML = "Listen to the Sentence and Choose your Response";
                            sentenceIdx = Math.floor(Math.random() * 288);
                            setTimeout(function () {
                                playTrial(sentenceIdx);
                                sibTrialPlay = true;
                            }, 1000);
                            sentenceRandIdx.push(sentenceIdx);
                            sibTrialVols.push(sibTrialVolume - sibStartTrialVolume);
                            flashInstructAlpha = 255;

                            sibTrialRT = sib.millis();
                        };
                    } else if (sibExpHandler.state == 4) {
                        if (buttonAccept.hovering == true) {
                            buttonAccept.hovering = false;
                            if (sibClickAllow && (sibTrialPresses.reduce((a, b) => a + b, 0) == 5)) {
                                sibClickAllow = false;
                                sibTrialPlay = false;

                                sibRTs.push(sib.millis() - sibTrialRT);

                                setTimeout(function () {
                                    document.getElementById('title_div').innerHTML = "Listen to the Next Sentence and Choose your Response";
                                    buttonAccept.hovering = false;
                                }, 1500);
                                evalWordChoices();
                                adaptiveExpTrial(sentenceVerdict[sentenceVerdict.length - 1]);
                                setTimeout(function () {
                                    sibClickAllow = true;
                                    for (var i = 0; i < textBox.length; i++) {
                                        textBox[i].fillVal = 225;
                                        textBox[i].pressed = false;
                                    };
                                }, 4000);
                                sibProgress = ((sibReversals / 10) * 100)
                                document.getElementById('progressBar').style.width = sibProgress.toString() + '%';
                                if (sibReversals == 10) {
                                    document.getElementById('sib_div').style.display = "none";
                                    sibThreshold = calcThreshold(sibRevVols, 5); // For last 5 reversals

                                    date = new Date;
                                    timeprint = `${("0" + (date.getDate())).slice(-2)}` + `${("0" + (date.getMonth() + 1)).slice(-2)}` + `${date.getFullYear()}` + `${("0" + (date.getHours())).slice(-2)}` + `${("0" + (date.getMinutes())).slice(-2)}`;
                                    timings.sibFinishTime = `${("0" + (date.getHours())).slice(-2)}` + `${("0" + (date.getMinutes())).slice(-2)}`;

                                    taskresults.child(userID).child('sib').child(timeprint).set({
                                        'sibTrialdBVols': sibTrialVols,
                                        'sibTrialRTs': sibRTs
                                    }).catch(err => {
                                        console.log(err.message);
                                    });
                                    if (userID == 'debug') {
                                        displayDebugResults(sibTrialVols);
                                        document.getElementById('resultsChart').style.display = 'block';
                                    } else {
                                        document.getElementById('sib_div').style.display = 'none';
                                        document.getElementById('controller_div').style.display = 'block';
                                        document.getElementById('debrief_div').style.display = 'block';
                                        audcog.sib = false;
                                    };
                                };
                            };
                        };
                    };
                } else {
                    document.getElementById('title_div').innerHTML = "Results";
                };
            };
        }

        function evalWordChoices() {
            var pressCount = 0;
            var pressedListIdx = [];
            for (var i = 0; i < textBox.length; i++) {
                if (textBox[i].pressed) {
                    pressedListIdx.push(i);
                    sentenceChoice = sentenceChoice + textBox[i].text + '_';
                    pressCount++;
                };
            };

            if (pressCount == 5) {
                console.log('Choice was ... ' + sentenceChoice.substring(0, sentenceChoice.length - 1));
                if (sibExpHandler.state == 2) {
                    console.log('Target was ... ' + sentenceList[samplePracticeList[sampleCount]]);
                    if (sentenceList[samplePracticeList[sampleCount]] == sentenceChoice.substring(0, sentenceChoice.length - 1)) {
                        // for (var i=0; i<pressedListIdx.length; i++) {
                        //     textBox[pressedListIdx[i]].fillVal = 'rgba(0,255,0, 0.25)';
                        // };
                        document.getElementById('title_div').innerHTML = 'Correct';
                        console.log('Correct');
                        samplePracticeResp[sampleCount] = 1;
                    } else {
                        // for (var i=0; i<pressedListIdx.length; i++) {
                        //     textBox[pressedListIdx[i]].fillVal = 'rgba(255,0,0, 0.25)';
                        // };
                        document.getElementById('title_div').innerHTML = 'Wrong';
                        console.log('Wrong');
                    };
                } else if (sibExpHandler.state == 4) {
                    console.log('Target was ... ' + sentenceList[sentenceIdx]);
                    if (sentenceList[sentenceIdx] == sentenceChoice.substring(0, sentenceChoice.length - 1)) {
                        // for (var i=0; i<pressedListIdx.length; i++) {
                        //     textBox[pressedListIdx[i]].fillVal = 'rgba(0,255,0, 0.25)';
                        // };
                        document.getElementById('title_div').innerHTML = 'Correct';
                        console.log('Correct');
                        sentenceVerdict.push(1);
                    } else {
                        // for (var i=0; i<pressedListIdx.length; i++) {
                        //     textBox[pressedListIdx[i]].fillVal = 'rgba(255,0,0, 0.25)';
                        // };
                        document.getElementById('title_div').innerHTML = 'Wrong';
                        console.log('Wrong');
                        sentenceVerdict.push(0);
                    };
                };
            } else {
                document.getElementById('title_div').innerHTML = 'Please make sure there is a choice in every column';
                setTimeout(function () {
                    document.getElementById('title_div').innerHTML = "Listen carefully to the sentence";
                }, 1500);
            };
            sentenceChoice = "";
            sibTrialPresses = [0, 0, 0, 0, 0];
        }

        // Create the Speech-in-Noise Task p5js Instance
        let babble, csv;
        let buttonInstruct, buttonReadySet, buttonAccept;
        let sibIntroVideo;
        const sib_s = p => {
            // Preload Babble wav file and the Text File with sentence lists to cache
            p.preload = () => {
                if (audcog.sib) {
                    babble = p.loadSound('static/audio/babble3.wav');
                    csv = p.loadTable('static/audio/corpus_data.csv', 'csv');
                    sibIntroVideo = p.createVideo("static/videos/audcog_prevent_sib.mp4");
                };
            }

            p.setup = () => {
                let canvas = p.createCanvas(900, 700);
                canvas.mousePressed(sibMousePressed);

                sibIntroVideo.size(800, 500);
                sibIntroVideo.hide();
                sibIntroVideo.volume(1);
                sibIntroVideo.play();

                sibExpHandler = new sibState(0);

                buttonInstruct = new Button(p.width / 2, 650, 40, sib);
                buttonPracticeInstruct = new Button(p.width / 2, 650, 40, sib);
                buttonPracticeRepeat = new Button(p.width / 2 - 90, 650, 40, sib);
                buttonPracticeNext = new Button(p.width / 2 - 90, 650, 40, sib);
                buttonReadySet = new Button(p.width / 2, 650, 40, sib);
                buttonAccept = new Button(p.width / 2 - 90, 650, 40, sib);

                // All sentence wav files are loaded to cache before experiment starts
                for (let i = 0; i < csv.rows.length; i++) {
                    sentenceList[i] = csv.rows[i].arr[7];
                };

                for (let j = 1; j < 6; j++) {
                    let categWords = [];
                    for (let k = 0; k < 10; k++) {
                        categWords[k] = csv.rows[k].arr[j];
                    };
                    preWordList.push(categWords.sort());
                };

                for (let j = 0; j < 5; j++) {
                    for (let k = 0; k < 10; k++) {
                        wordList.push(preWordList[j][k]);
                    };
                };

                let startX = 100; let stepX = 150;
                let startY = 50; let stepY = 60;
                let wordStep = 10;
                let wordCount = 0;

                for (let i = 0; i < 5; i++) {
                    for (let j = 0; j < 10; j++) {
                        let wordListIdx = j + (wordStep * i);
                        textBox[wordCount] = new choiceBox(startX + (stepX * i), startY + (stepY * j), wordList[wordListIdx]);
                        wordCount++;
                    };
                };
            }

            // The main experimental loop on the HTML Canvas. This loops at 60Hz and experimental stages are controlled by sibExpHandler
            p.draw = () => {
                if (audcog.sib) {
                    p.background(255);
                    if (sibExpHandler.state == 0) {
                        instructions(sib);
                    } else if (sibExpHandler.state == 1) {
                        practiceInstructions(sib);
                    } else if (sibExpHandler.state == 2) {
                        practiceTrial(sib);
                    } else if (sibExpHandler.state == 3) {
                        readySet(sib);
                    } else if (sibExpHandler.state == 4) {
                        mainExp(sib);
                    };
                };
            }
        }

        // Create SIB Instance Mode
        let sib;
        function createSIB() {
            sib = new p5(sib_s, 'sib_div');
            document.getElementById('progressBar').style.width = sibProgress.toString() + '%';
        }

        function instructions(p5instance) {
            let img = sibIntroVideo.get();
            sib.image(img, 50, 0);
            p5instance.textSize(25);
            p5instance.fill(50);
            p5instance.textAlign(p5instance.CENTER);
            p5instance.text("Click below after the video", p5instance.width / 2, 580);
            buttonInstruct.show(p5instance);
            buttonInstruct.hover(p5instance.mouseX, p5instance.mouseY, p5instance);
            flashInstruct(flashInstructFadeRate, sib);
        }

        function practiceInstructions(p5instance) {
            let s = 'In this practice session, you will have two trials\n\nPress the button to play sound\n\nChoose or guess the words that were said!\n\n\nThen press the button at the bottom again';
            p5instance.fill(0, 150);
            p5instance.textSize(30);
            p5instance.textFont('Georgia');
            p5instance.textAlign(p5instance.CENTER, p5instance.CENTER);
            p5instance.text(s, p5instance.width / 2, p5instance.height / 2 - 50);
            p5instance.textSize(25);
            p5instance.fill(50);
            p5instance.text("Start Practice by clicking below", p5instance.width / 2, 580);
            buttonPracticeInstruct.show(p5instance);
            buttonPracticeInstruct.hover(p5instance.mouseX, p5instance.mouseY, p5instance);
            flashInstruct(flashInstructFadeRate, sib);
        }

        function readySet(p5instance) {
            let s = 'Now you will begin the actual task\n\nIt will take around 3 mins\n\nPress the button below to proceed';
            p5instance.fill(0, 150);
            p5instance.textSize(30);
            p5instance.textFont('Georgia');
            p5instance.textAlign(p5instance.CENTER, p5instance.CENTER);
            p5instance.text(s, p5instance.width / 2, p5instance.height / 2 - 50);
            p5instance.textSize(25);
            p5instance.fill(50);
            p5instance.text('Start Main Task by clicking below', p5instance.width / 2, 580);
            buttonReadySet.show(p5instance);
            buttonReadySet.hover(p5instance.mouseX, p5instance.mouseY, p5instance);
            flashInstruct(flashInstructFadeRate, sib);
        }

        function flashInstruct(rate, p5instance) {
            p5instance.push();
            p5instance.fill(255, flashInstructAlpha);
            p5instance.noStroke();
            p5instance.rectMode(p5instance.CENTER);
            p5instance.rect(p5instance.width / 2, p5instance.height / 2, 900, 700);
            flashInstructAlpha -= rate;
            p5instance.pop();
        }

        function flashPracticeInstruct(p5instance) {
            p5instance.push();
            p5instance.fill(255, flashPracticeInstructAlpha);
            p5instance.noStroke();
            p5instance.rectMode(p5instance.CENTER);
            p5instance.rect(p5instance.width / 2, p5instance.height / 2 - 100, 900, 650);
            // flashPracticeInstructAlpha -= Math.pow(Math.E, 1/flashPracticeInstructAlpha);
            p5instance.stroke(0);
            p5instance.fill(0, 50, 200, 200);
            p5instance.triangle(265, 650, 255, 620, 275, 620);
            p5instance.triangle(450, 650, 440, 620, 460, 620);
            p5instance.triangle(650, 650, 640, 620, 660, 620);
            p5instance.pop();
        }

        let sibTrialPlay = false;
        function practiceTrial(p5instance) {
            for (var i = 0; i < 50; i++) {
                textBox[i].show(p5instance);
                textBox[i].mouseisover(p5instance.mouseX, p5instance.mouseY);
            };
            p5instance.textSize(25);
            p5instance.fill(50);
            if (sibTrialPlay && (sibTrialPresses.reduce((a, b) => a + b, 0) == 5)) {
                p5instance.text('Next Trial', p5instance.width / 2, 650);
                buttonPracticeNext.show(p5instance);
                buttonPracticeNext.hover(p5instance.mouseX, p5instance.mouseY, p5instance);
            } else if (!sibTrialPlay) {
                p5instance.text('Play Sentence', p5instance.width / 2 + 20, 650);
                buttonPracticeRepeat.show(p5instance);
                buttonPracticeRepeat.hover(p5instance.mouseX, p5instance.mouseY, p5instance);
            } else {
                p5instance.textSize(30); p5instance.fill('red');
                p5instance.text('choose an option from each column', p5instance.width / 2, 650);
            };
            p5instance.textSize(25);
            flashInstruct(flashInstructFadeRate, sib);
            //flashPracticeInstruct();
        }

        function mainExp(p5instance) {
            for (var i = 0; i < 50; i++) {
                textBox[i].show(p5instance);
                textBox[i].mouseisover(p5instance.mouseX, p5instance.mouseY);
            };
            p5instance.textSize(25);
            p5instance.fill(50);
            if (sibTrialPresses.reduce((a, b) => a + b, 0) == 5) {
                p5instance.text('Accept Choice', p5instance.width / 2 + 20, 650);
                buttonAccept.show(p5instance);
                buttonAccept.hover(p5instance.mouseX, p5instance.mouseY, p5instance);
            } else {
                p5instance.textSize(30); p5instance.fill('red');
                p5instance.text('choose an option from each column', p5instance.width / 2, 650);
            };
            flashInstruct(flashInstructFadeRate, sib);
        }

        let sibSentArray = []; let sibBabbleArray = [];
        function playTrial(sentenceNumber) {
            // Load the specific sentence audio file to cache before the trial starts
            sentenceFile = sib.loadSound('static/audio/' + sentenceList[sentenceNumber] + '.flac', loadedCallback, errorCallback);

            function loadedCallback() {
                // Audio is ready to be played
                sibSentArray = sentenceFile.buffer.getChannelData(0);
                sibBabbleArray = babble.buffer.getChannelData(0);

                if (sibExpHandler.state == 2) {
                    adjustSoundTMRdB(sibSentArray, 40, 1);
                } else {
                    adjustSoundTMRdB(sibSentArray, sibTrialVolume, 1);
                }
                sibRmsCombineTMR(sibSentArray, sibBabbleArray);

                if (sibRMS == 0) {
                    sibRmsCombineTMR(sibSentArray, sibBabbleArray);
                }
                sibPlayStimuli();  // Only called once the audio is fully loaded
            }

            function errorCallback(err) {
                console.log('Error loading audio: ', err);
            }
            flashInstruct(flashInstructFadeRate, sib);
        }

        // Combines a Target and Masker sound by using Root Mean Squared normalising for the SIB stimuli
        let sibCombinedArray = []; let sibCombinedBuffer; let maskerArrayShort;
        let sibRMS;
        function sibRmsCombineTMR(targetArray, maskerArray) {

            maskerArrayShort = [];
            let maskerSampleStart = Math.floor(Math.random() * 18 * 48000);
            let maskerSampleStop = maskerSampleStart + (3 * 48000);

            for (let i = maskerSampleStart; i < maskerSampleStop; i++) {
                maskerArrayShort.push(maskerArray[i]);
            };

            sibCombinedArray = [];
            for (let i = 0; i < maskerArrayShort.length; i++) {
                sibCombinedArray[i] = 0;
            };

            let a = 0;
            for (let i = 0; i < maskerArrayShort.length; i++) {
                if (i < 12000) {
                    sibCombinedArray[i] = 0 + maskerArrayShort[i];
                } else if ((i >= 12000) && (i < targetArray.length)) {
                    sibCombinedArray[i] = targetArray[a] + maskerArrayShort[i]; // 
                    a++;
                } else {
                    sibCombinedArray[i] = 0 + maskerArrayShort[i];
                };
            };

            let powArray = [];
            // Obtain Standard Deviation (RMS) of Combined Array values
            for (let i = 0; i < sibCombinedArray.length; i++) {
                powArray.push(Math.pow(sibCombinedArray[i], 2));
            };

            sibRMS = Math.sqrt((powArray.reduce((a, b) => a + b, 0) / powArray.length) || 0);
            console.log(sibRMS);

            // Normalise Concatenated Array by RMS value
            for (let i = 0; i < sibCombinedArray.length; i++) {
                sibCombinedArray[i] = sibCombinedArray[i] / (sibRMS * 4);
            };

            sibCombinedArray = new Float32Array(sibCombinedArray);

        }

        // Play Adjusted SIB Stimulus in Web Audio API
        function sibPlayStimuli() {
            let sibAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
            sibCombinedBuffer = sibAudioCtx.createBuffer(1, maskerArrayShort.length, sibAudioCtx.sampleRate);
            sibCombinedBuffer.copyToChannel(sibCombinedArray, 0, 0);
            let source = sibAudioCtx.createBufferSource();
            source.buffer = sibCombinedBuffer;
            source.connect(sibAudioCtx.destination);
            source.start();

        }

        function adaptiveExpTrial(result) {
            for (var i = 0; i < textBox.length; i++) {
                textBox[i].fillVal = 225;
                textBox[i].pressed = false;
            };

            // Main function to adapt the sentence (signal) to babble (target) volume ratio
            if (sentenceVerdict.length > 1 && (sentenceVerdict[sentenceVerdict.length - 2] != sentenceVerdict[sentenceVerdict.length - 1])) {
                sibReversals += 1;
                sibRevVols.push(sibTrialVolume - sibStartTrialVolume);
                console.log('Reversal detected');
            };
            if (sibReversals < 10) {
                sentenceIdx = Math.floor(Math.random() * 288);
                sentenceRandIdx.push(sentenceIdx);
                if (result == 1) {
                    if (sibReversals < 2) {
                        sibTrialVolume -= sibVolSteps[0];
                        sibTrialVols.push(sibTrialVolume - sibStartTrialVolume);
                    } else if (sibReversals < 5) {
                        sibTrialVolume -= sibVolSteps[1];
                        sibTrialVols.push(sibTrialVolume - sibStartTrialVolume);
                    } else {
                        sibTrialVolume -= sibVolSteps[2];
                        sibTrialVols.push(sibTrialVolume - sibStartTrialVolume);
                    };
                } else {
                    if (sibReversals < 2) {
                        sibTrialVolume += sibVolSteps[0];
                        sibTrialVols.push(sibTrialVolume - sibStartTrialVolume);
                    } else if (sibReversals < 5) {
                        sibTrialVolume += sibVolSteps[1];
                        sibTrialVols.push(sibTrialVolume - sibStartTrialVolume);
                    } else {
                        sibTrialVolume += sibVolSteps[2];
                        sibTrialVols.push(sibTrialVolume - sibStartTrialVolume);
                    };
                };
                console.log('The volume is set at ' + (sibTrialVolume - sibStartTrialVolume));
                setTimeout(function () {
                    playTrial(sentenceIdx);
                }, 2000);
            } else {
                sibExpHandler.state = 4;
            };
        }

        // Takes a sound array and the required dB value to adjust sound array and plays it
        function adjustSoundTMRdB(soundArray, dB, channels) {
            if (channels == 2) {
                for (let channel = 0; channel < 2; channel++) {
                    for (let i = 0; i < soundArray[channel].length; i++) {
                        soundArray[channel][i] = soundArray[channel][i] * Math.pow(10, dB / 20);
                    };
                };
            } else {
                for (let i = 0; i < soundArray.length; i++) {
                    soundArray[i] = soundArray[i] * Math.pow(10, dB / 20);
                };
            };
        }

        // Calculates threshold for task based on inputted last number of reversals
        function calcThreshold(array, number) {
            let revs = [];
            for (let x = -number; x < 0; x++) {
                revs.push(array[array.length + x]);
            };
            return (revs.reduce((a, b) => a + b, 0) / revs.length);
        }
    </script>

</body>

</html>