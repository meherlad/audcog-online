<html>

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
        integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="static/main.css">

    <title> AudCog - Great Minds </title>

</head>

<body>
    <header class="site-header">
        <nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top" id="audcog_header">
            <div class="container">
                <a class="navbar-brand mx-auto" href="/"> AudCog: Great
                    Minds</a>
            </div>
        </nav>
    </header>

    <main role="main" class="container-fluid py-2">
        <div class="row justify-content-center">
            <div class="col">
            </div>

            <!-- Appearances of all divs in this container are run by main.js -->
            <div class="col-md-12">

                <!-- Title Div is shown to guide a participant through task -->
                <div class="content-section text-center font-weight-bold border-0 h3" id="title_div">
                </div>

                <div class="progress" style="height: 30px;">
                    <div class="progress-bar progress-bar-striped bg-info" id=progressBar role="progressbar"
                        style="width: 0%" aria-valuemin="0" aria-valuemax="100"></div>
                </div>

                <!-- This Error Div comes up if the browser is not Chrome or the Screen is less than 1000 pixels wide and 500 pixels high -->
                <div class="content-section" id="browser_device_error" style='display:none'>
                    <p> This device or browser is not supported OR </p>
                    <p> Your screen is too small </p>
                    <p> Please use Google Chrome on a Desktop or Laptop computer </p>
                    <p> Try maximizing your browser window and refresh the webpage </p>
                </div>

                <div class="content-section" id="id_error" style='display:none'>
                    <p> Your ID is not registered to take part </p>
                    <p> Or there is an error in the way it is entered </p>
                    <p> </p>
                    <p> Please contact
                        <span class="font-weight-bold">audcog@ncl.ac.uk
                        </span>for more information
                    </p>
                </div>

                <!-- Login Page is shown when someone first encounters the website -->
                <div class="content-section text-center border-0 p-5" id="login_div">
                    <h6 class="text-dark font-weight-normal py-2"> Press the <span class="font-weight-bold"> 'START'
                        </span>button below to <span class="font-weight-bold">Begin </span></h5>
                        <div>
                            <div class='p-2'>
                                <button id='submitbutton' class="btn btn-dark border-dark font-weight-bold py-2"
                                    type='button'> START </button>
                            </div>
                        </div>
                        <div class="text-center">
                            <input id='dashPassword' type='text' class='p-4' style='visibility:hidden'>
                        </div>
                        <div class="text-danger font-weight-bold p-2">
                            <a id="error_message"> </a>
                        </div>
                        <h6 class="text-danger font-weight-normal"> <span class="font-weight-bold"> WARNING: </span> Do
                            not use Safari as a web browser. Remember to use Headphones too! </h5>
                </div>

                <!-- Controller Div is shown when an experimenter wants to test a task -->
                <div class="content-section text-center border-0" id="controller_div" style='display:none'>
                    <div class="form-group" id="debrief_div" style='display:none'>
                        <div class="col m-3 p-3 border border-secondary rounded bg-light">
                            <h5 class="text-muted p-2"> Thank you for participating in the AudCog study. </h5>
                            <h5 class="text-muted p-2"> You contribution will help us understand the link between
                                hearing ability and risk for dementia. </h5>
                            <h5 class="text-muted p-2"> As mentioned previously, these were research tests only so we do
                                not provide any feedback on performance. </h5>
                            <hr>
                            <h5 class="text-muted p-2"> You are eligible for a Â£50 Amazon voucher </h5>
                            <h6 class="text-muted font-weight-light p-2"> If you would like to be entered into a draw
                                for this, please email the
                                address below </h6>
                            <h6 class="text-muted font-weight-normal p-2"> audcog@ncl.ac.uk </h6>
                        </div>
                        <h5 class="text-dark font-weight-normal p-1"> You may now close this window </h5>
                    </div>
                </div>

                <!-- Digits In Noise Task Div is shown when begins the task run on awm.js -->
                <div class="content-section text-center border-0" id="din_div" style='display:none'>
                </div>

            </div>
        </div>
    </main>

    <!-- Optional JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/p5@1.4.0/lib/p5.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/addons/p5.sound.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.8.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.8.1/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.8.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.8.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/7.1.0/math.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script src='https://unpkg.com/simple-statistics@7.7.0/dist/simple-statistics.min.js'></script>
    <script src="https://cdn.plot.ly/plotly-2.6.3.min.js"></script>

    <script>
        // Login to Firebase Database
        let userID, database, taskresults;
        window.addEventListener('DOMContentLoaded', (event) => {
            console.log('DOM fully loaded and parsed');
            // Browser and device checks
            const isChrome = /chrome/.test(navigator.userAgent.toLowerCase());
            const isSuitable = true; //(window.innerWidth > 400) && (window.innerHeight > 200)

            // Doesn't have to be Chrome for the time being
            if (isSuitable) {

                userID = getUserIDFromQueryString();

                if (!userID) { // Check if userID is null or empty
                    document.getElementById('login_div').style.display = 'none';
                    document.getElementById('id_error').style.display = 'block';
                }


                // Your web app's Firebase configuration
                const firebaseConfig = {
                    apiKey: "AIzaSyDPTy_twUrqEXlVfpALoqYkPdcux7klcEQ",
                    authDomain: "audcog-online.firebaseapp.com",
                    databaseURL: "https://audcog-online-default-rtdb.europe-west1.firebasedatabase.app",
                    projectId: "audcog-online",
                    storageBucket: "audcog-online.appspot.com",
                    messagingSenderId: "652871235053",
                    appId: "1:652871235053:web:7776007488c3ccf30163e4",
                    measurementId: "G-PCY56CPWHB"
                };
                // Initialize Firebase
                firebase.initializeApp(firebaseConfig);
                firebase.analytics();
                database = firebase.database();
                taskresults = database.ref('audcog-online');
                auth = firebase.auth();

            } else {
                login_div.style.display = 'none';
                browser_device_error_div.style.display = 'block';
            };
        });

        // Authenticate User and Create global variables needed to store in Database
        let database_uid, allVisits, userVisits;

        // Function to extract userID from the query string
        function getUserIDFromQueryString() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('userID');
        }

        document.getElementById('submitbutton').addEventListener('click', function () {
            login_div.style.display = 'none';
            document.getElementById('din_div').style.display = 'block';
            createDIN();
        });

        // This script includes code for controlling the state of the Experimental workflow
        //
        // In debugging mode, a p5js canvas displays buttons that allow a user to test each task
        // 
        // In experimental mode, the user is taken directly to a set of general instructions and progresses to each task
        //
        let date = new Date;
        let timings = {
            expStartTime: `${("0" + (date.getHours())).slice(-2)}` + `${("0" + (date.getMinutes())).slice(-2)}`,
            expFinishTime: 0,
            awmStartTime: 0,
            awmFinishTime: 0,
        };

        // Generic Classes and Functions

        class Button {
            constructor(locX, locY, rad, p5instance) {
                this.x = locX;
                this.y = locY;
                this.rad = rad;
                this.hovering = false;
                this.p5instance = p5instance;
            };
            show(p5instance) {
                p5instance.push();
                p5instance.fill(255, 255, 255, 150);
                p5instance.stroke(100);
                p5instance.strokeWeight(1);
                p5instance.circle(this.x, this.y, this.rad);
                p5instance.pop();
            };
            hover(px, py, p5instance) {
                if (p5instance.dist(px, py, this.x, this.y) < this.rad / 2) {
                    p5instance.push();
                    p5instance.fill('red');
                    p5instance.stroke(100);
                    p5instance.strokeWeight(3);
                    p5instance.circle(this.x, this.y, this.rad + 10);
                    this.hovering = true;
                    p5instance.pop();
                } else {
                    this.hovering = false;
                };
            };
        }

        // All clickable buttons with words, during the response phase, are produced with this class
        class choiceBox {
            constructor(x, y, text) {
                this.x = x;
                this.y = y;
                this.width = 100;
                this.height = 50;
                this.textSize = 20
                this.text = text;
                this.over = false;
                this.pressed = false;
                this.fillVal = 225;
            }

            show(p5instance) {
                p5instance.push();
                p5instance.fill(this.fillVal);
                p5instance.rectMode(p5instance.CENTER);
                p5instance.rect(this.x, this.y, this.width, this.height, 10);
                p5instance.fill(0);
                p5instance.textSize(this.textSize);
                p5instance.textAlign(p5instance.CENTER, p5instance.CENTER);
                p5instance.text(this.text, this.x, this.y);
                p5instance.strokeWeight(2);
                p5instance.stroke(255);
                p5instance.pop();
            }

            mouseisover(px, py) {
                if (this.pressed == false) {
                    if ((Math.abs(this.x - px) < this.width / 2) && (Math.abs(this.y - py) < this.height / 2)) {
                        this.fillVal = 200;
                        this.over = true;
                    } else {
                        this.fillVal = 225;
                        this.over = false;
                    };
                } else {
                    if ((Math.abs(this.x - px) < this.width / 2) && (Math.abs(this.y - py) < this.height / 2)) {
                        this.fillVal = 100;
                        this.over = true;
                    } else {
                        this.fillVal = 125;
                        this.over = false;
                    };
                };
            }

            clicked() {
                this.fillVal = 125;
                this.pressed = true;
            }
        }

        class playButton {
            constructor(locX1, locX2, locY1, locY2, locZ1, locZ2) {
                this.x1 = locX1;
                this.y1 = locY1;
                this.z1 = locZ1;
                this.x2 = locX2;
                this.y2 = locY2;
                this.z2 = locZ2;
                this.hovering = false;
                this.pressed = false;
                this.fillVal = 'red';
            };
            show(p5instance) {
                p5instance.push();
                p5instance.fill('white');
                p5instance.rect(this.x1 + 25, this.z2, 100, 80);
                p5instance.fill(this.fillVal);
                if (!this.pressed) {
                    p5instance.triangle(this.x1, this.x2, this.y1, this.y2, this.z1, this.z2);
                } else {
                    p5instance.rect(this.x1 + 10, this.z2, 20, 60);
                    p5instance.rect(this.x1 + 40, this.z2, 20, 60);
                };
                p5instance.pop();
            };
            hover(px, py, p5instance) {
                if (p5instance.dist(px, py, this.z1 - 25, this.z2) < 50) {
                    p5instance.push();
                    p5instance.fill('grey');
                    p5instance.rect(this.x1 + 25, this.z2, 100, 80);
                    p5instance.fill(this.fillVal);
                    if (!this.pressed) {
                        p5instance.triangle(this.x1, this.x2, this.y1, this.y2, this.z1, this.z2);
                    } else {
                        p5instance.rect(this.x1 + 10, this.z2, 20, 60);
                        p5instance.rect(this.x1 + 40, this.z2, 20, 60);
                    };
                    p5instance.pop();
                    this.hovering = true;
                } else {
                    this.hovering = false;
                };
            };
            clicked() {
                this.pressed = !this.pressed;
                if (this.pressed) {
                    this.fillVal = 'green';
                } else {
                    this.fillVal = 'red';
                };
            };
        }

        // Global Experimental Variables

        // audcog controls event handlers for each task
        let audcog = {
            din: true,
        }

        // Some Helper Functions
        //
        // Shuffle array function
        function shuffle(array) {
            let currentIndex = array.length, randomIndex;
            // While there remain elements to shuffle
            while (currentIndex != 0) {
                // Pick a remaining element
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                // And swap it with the current element
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            };
            return array;
        }

        // Create evently spaced values from startValue to stopValue
        function linSpace(startValue, stopValue, cardinality) {
            var arr = [];
            var step = (stopValue - startValue) / (cardinality - 1);
            for (var i = 0; i < cardinality; i++) {
                arr.push(startValue + (step * i));
            }
            return arr;
        }

        let flashInstructAlpha = 255; let flashPracticeInstructAlpha = 255; let flashInstructFadeRate = 5;

        // 
        // Antephase Digits in Noise Task - De Sousa et al. Ear and Hearing. 2019
        //
        // This task tests digits in noise perception using an adaptive 1-up, 1-down paradigm
        // 50% thresholds are calculated using a mean of the last 6 reversals (task stops after 10 reversals)
        // Sentences consist of 3 digits  on a background of Speech Shaped White Noise
        // Speakers talk in English with a Southern English accent
        //
        // Created by Meher Lad - August 2021
        //

        let dinNumbBox = [];
        let dinNoDigits = 10;
        let dinNumbProbe = ""; let dinPressList = "";
        let dinClickAllow = true;

        let dinExpHandler;
        let dinPracticeList = [3, 6, 8];
        let dinPracticeResp = [0, 0]; let dinPracIdx = 0;
        let dinPracStimPlayed = false;
        let dinPracticeVol = 0.02;

        let dinNumbFiles = [];
        let dinTrialPresses = 0;
        let dinTrialVerdict = []; let dinTrialVols = [0];
        let dinStartTrialVolume = 10; let dinTrialVolume = dinStartTrialVolume;
        let dinVoldBSteps = [10, 5, 2, 1];
        let dinRevSteps = [2, 4, 6, 11]; // up to how many reversals to do each step
        let dinProgress = 0;
        const maxReversals = dinRevSteps[dinRevSteps.length - 1];
        let dinRevVols = []; let dinThreshold;
        let dinVolStepIdx = 0;
        let dinReversals = 0;
        let dinTrialRT = 0; let dinRTs = [];

        // This function controls the state of the Speech-in-Noise Task
        //
        // 0 brings a participant to the main instructions section
        // 1 to the practice instructions
        // 2 to the practice trial
        // 3 tp the get ready section
        // 4 to the main part of the experiment
        //
        class dinState {
            constructor(state) {
                this.state = state;
            }
        }

        // All clickable buttons with numbers, during the response phase, are produced with this class
        class dinChoiceBox {
            constructor(x, y, text) {
                this.x = x;
                this.y = y;
                this.width = 50;
                this.height = 50;
                this.text = text;
                this.over = false;
                this.pressed = false;
                this.fillVal = 225;
            }

            show(p5instance) {
                p5instance.push();
                p5instance.fill(this.fillVal);
                p5instance.rectMode(p5instance.CENTER);
                p5instance.rect(this.x, this.y, this.width, this.height, 10);
                p5instance.fill(0);
                p5instance.textSize(30);
                p5instance.textAlign(p5instance.CENTER, p5instance.CENTER);
                p5instance.text(this.text, this.x, this.y);
                p5instance.strokeWeight(2);
                p5instance.stroke(255);
                p5instance.pop();
            }

            mouseisover(px, py) {
                if (this.pressed == false) {
                    if ((Math.abs(this.x - px) < this.width / 2) && (Math.abs(this.y - py) < this.height / 2)) {
                        this.fillVal = 200;
                        this.over = true;
                    } else {
                        this.fillVal = 225;
                        this.over = false;
                    };
                };
            }

            clicked() {
                this.fillVal = 125;
                this.pressed = !this.pressed;
            }
        }

        // Deals with mouse being pressed in the DIN instance
        var dinMousePressed = () => {
            if (audcog.din) {
                if (dinExpHandler.state == 0) {
                    if (dinButtonInstruct.hovering == true) {
                        dinIntroVideo.pause();
                        dinExpHandler.state = 1;
                        dinProgress = ((dinReversals / maxReversals) * 100)
                        document.getElementById('progressBar').style.width = dinProgress.toString() + '%';
                        document.getElementById('title_div').innerHTML = "Instructions";
                        flashInstructAlpha = 255;
                    };
                } else if (dinExpHandler.state == 1) {
                    if (dinButtonPracticeInstruct.hovering == true) {
                        dinExpHandler.state = 2;
                        document.getElementById('title_div').innerHTML = "Practice - Sample 1";
                        flashInstructAlpha = 255;
                    };
                } else if (dinExpHandler.state == 3) {
                    if (dinButtonReadySet.hovering) {
                        date = new Date;
                        timings.dinStartTime = `${("0" + (date.getHours())).slice(-2)}` + `${("0" + (date.getMinutes())).slice(-2)}`;

                        setTimeout(function () {
                            dinPlayTrial();
                        }, 2000);
                        dinExpHandler.state = 4;
                        document.getElementById('title_div').innerHTML = "Main Task";
                        flashInstructAlpha = 255;

                        dinTrialRT = din.millis();
                    };
                } else if ((dinExpHandler.state == 2) || (dinExpHandler.state == 4)) {
                    for (let i = 0; i < dinNoDigits; i++) {
                        if (dinNumbBox[i].over && !dinNumbBox[i].pressed && (dinTrialPresses < 3)) {
                            dinNumbBox[i].clicked();
                            setTimeout(function () {
                                dinNumbBox[i].pressed = false;
                            }, 500);
                            dinPressList = dinPressList + i.toString();
                            dinTrialPresses++;
                        }
                    };
                    if (dinBackspace.over && dinTrialPresses > 0) {
                        dinBackspace.clicked();
                        setTimeout(function () {
                            dinBackspace.clicked();
                        }, 500);
                        dinPressList = dinPressList.slice(0, -1);
                        dinTrialPresses--;
                    };
                    if (dinExpHandler.state == 2) {
                        if (dinButtonPracticeRepeat.hovering) {
                            if (dinClickAllow) {
                                dinClickAllow = false;
                                dinButtonPracticeRepeat.hovering = false;
                                dinPracStimPlayed = true;
                                dinPlayTrial();
                                setTimeout(function () {
                                    dinClickAllow = true;
                                    for (var i = 0; i < dinNumbBox.length; i++) {
                                        dinNumbBox[i].fillVal = 225;
                                        dinNumbBox[i].pressed = false;
                                    };
                                }, 4000);
                            };
                        };
                        if (dinButtonPracticeNext.hovering) {
                            dinButtonPracticeNext.hovering = false;
                            dinPracStimPlayed = false;
                            dinEvalNumbChoices();
                            setTimeout(function () {
                                if (dinPracticeResp[0] == 1) {
                                    dinPracticeResp[0] = 1;
                                    document.getElementById('title_div').innerHTML = "Practice - Sample 2";
                                    if (dinPracticeResp[1]) {
                                        dinExpHandler.state = 3;
                                        document.getElementById('title_div').innerHTML = "Ready Set";
                                        flashInstructAlpha = 255;
                                    };
                                } else {
                                    document.getElementById('title_div').innerHTML = "Try Again";
                                    setTimeout(function () {
                                        document.getElementById('title_div').innerHTML = "Practice";
                                    }, 1500);
                                };
                            }, 1500);
                        };
                    } else if (dinExpHandler.state == 4) {
                        if (dinButtonAccept.hovering == true) {
                            dinButtonAccept.hovering = false;
                            if (dinClickAllow && dinTrialPresses == 3) {
                                dinClickAllow = false;

                                dinRTs.push(din.millis() - dinTrialRT);

                                dinEvalNumbChoices();
                                dinAdaptiveExpTrial(dinTrialVerdict[dinTrialVerdict.length - 1]);
                                setTimeout(function () {
                                    dinClickAllow = true;
                                    for (var i = 0; i < dinNumbBox.length; i++) {
                                        dinNumbBox[i].fillVal = 225;
                                        dinNumbBox[i].pressed = false;
                                    };
                                }, 4000);
                                dinProgress = ((dinReversals / maxReversals) * 100)
                                document.getElementById('progressBar').style.width = dinProgress.toString() + '%';
                                if (dinReversals == maxReversals) {
                                    document.getElementById('din_div').style.display = "none";
                                    dinThreshold = calcThreshold(dinRevVols, 5); // For last 5 reversals

                                    let date = new Date;
                                    let timeprint = `${("0" + (date.getDate())).slice(-2)}` + `${("0" + (date.getMonth() + 1)).slice(-2)}` + `${date.getFullYear()}` + `${("0" + (date.getHours())).slice(-2)}` + `${("0" + (date.getMinutes())).slice(-2)}`;
                                    timings.dinFinishTime = `${("0" + (date.getHours())).slice(-2)}` + `${("0" + (date.getMinutes())).slice(-2)}`;

                                    taskresults.child(userID).child('din').child(timeprint).set({
                                        'dinTrialdBs': dinTrialVols,
                                        'dinTrialRTs': dinRTs
                                    }).catch(err => {
                                        console.log(err.message);
                                    });
                                    if (userID == 'debug') {
                                        displayDebugResults(dinTrialVols);
                                        document.getElementById('resultsChart').style.display = 'block';
                                    } else {
                                        document.getElementById('din_div').style.display = 'none';
                                        document.getElementById('controller_div').style.display = 'block';
                                        document.getElementById('debrief_div').style.display = 'block';
                                        audcog.din = false;
                                    };
                                };
                            };
                        };
                    };
                } else if (dinExpHandler.state == 4) {

                };
            };
        }

        // Create the Digits-in-Noise Task p5js Instance
        let dinBgNoise, dinPreDigits, dinIntroVideo;
        const din_s = p => {
            // Preload Noise wav file
            p.preload = () => {
                if (audcog.din) {
                    dinBgNoise = p.loadSound('static/audio/noise.wav');
                    dinPreDigits = p.loadSound('static/audio/Carrier_WB.wav');
                    dinIntroVideo = p.createVideo("static/videos/audcog_prevent_din.mp4");
                };
            }

            p.setup = () => {
                let canvas = p.createCanvas(900, 700);
                canvas.mousePressed(dinMousePressed);

                dinIntroVideo.size(800, 500);
                dinIntroVideo.hide();
                dinIntroVideo.volume(1);
                dinIntroVideo.play();

                dinExpHandler = new dinState(0);

                dinButtonInstruct = new Button(p.width / 2, 600, 40, din);
                dinButtonPracticeInstruct = new Button(p.width / 2, 600, 40, din);
                dinButtonPracticeRepeat = new Button(p.width / 2 - 60, 580, 40, din);
                dinButtonReadySet = new Button(p.width / 2, 600, 40, din);
                dinButtonPracticeNext = new Button(p.width / 2 - 60, 580, 40, din);
                dinButtonAccept = new Button(p.width / 2 - 60, 580, 40, din);

                let startX = 300; let stepX = 100;
                let startY = 150; let stepY = 100;
                let numStep = 3; let numCount = 0;

                dinNumbBox[numCount] = new dinChoiceBox(400, 450, '0');
                numCount++;
                for (let i = 0; i < 3; i++) {
                    for (let j = 0; j < 3; j++) {
                        let numIdx = j + (numStep * i);
                        if (numIdx < dinNoDigits) {
                            dinNumbBox[numCount] = new dinChoiceBox(startX + (stepX * j), startY + (stepY * i), (1 + numIdx).toString());
                            numCount++;
                        };
                    };
                };
                dinBackspace = new dinChoiceBox(500, 450, '<');

            }

            // The main experimental loop on the HTML Canvas. This loops at 60Hz and experimental stages are controlled by dinExpHandler
            p.draw = () => {
                if (audcog.din) {
                    p.background(255);
                    if (dinExpHandler.state == 0) {
                        dinInstructions(din);
                    } else if (dinExpHandler.state == 1) {
                        dinPracticeInstructions(din);
                    } else if (dinExpHandler.state == 2) {
                        dinPracticeTrial(din);
                    } else if (dinExpHandler.state == 3) {
                        dinReadySet(din);
                    } else if (dinExpHandler.state == 4) {
                        dinMainExp(din);
                    } else {

                    };
                };
            }
        }

        // Create DIN Instance Mode
        let din;
        function createDIN() {
            din = new p5(din_s, 'din_div');
            document.getElementById('progressBar').style.width = dinProgress.toString() + '%';
        }

        function dinInstructions(p5instance) {
            let img = dinIntroVideo.get();
            din.image(img, 50, 0);
            p5instance.textSize(25);
            p5instance.fill(50);
            p5instance.textAlign(p5instance.CENTER);
            p5instance.text("Click below after the video", p5instance.width / 2, 560);
            dinButtonInstruct.show(p5instance);
            dinButtonInstruct.hover(p5instance.mouseX, p5instance.mouseY, p5instance);
            flashInstruct(flashInstructFadeRate, din);
        }

        function flashInstruct(rate, p5instance) {
            p5instance.push();
            p5instance.fill(255, flashInstructAlpha);
            p5instance.noStroke();
            p5instance.rectMode(p5instance.CENTER);
            p5instance.rect(p5instance.width / 2, p5instance.height / 2, 900, 700);
            flashInstructAlpha -= rate;
            p5instance.pop();
        }

        function flashPracticeInstruct(p5instance) {
            p5instance.push();
            p5instance.fill(255, flashPracticeInstructAlpha);
            p5instance.noStroke();
            p5instance.rectMode(p5instance.CENTER);
            p5instance.rect(p5instance.width / 2, p5instance.height / 2 - 100, 900, 650);
            // flashPracticeInstructAlpha -= Math.pow(Math.E, 1/flashPracticeInstructAlpha);
            p5instance.stroke(0);
            p5instance.fill(0, 50, 200, 200);
            p5instance.triangle(265, 650, 255, 620, 275, 620);
            p5instance.triangle(450, 650, 440, 620, 460, 620);
            p5instance.triangle(650, 650, 640, 620, 660, 620);
            p5instance.pop();
        }

        function dinPracticeInstructions(p5instance) {
            let s = 'In this practice session, you will have two trials\n\nPress the button to play sound\n\nChoose or guess the numbers that were said!\n\n\nThen press the button at the bottom again';
            p5instance.fill(0, 150);
            p5instance.textSize(30);
            p5instance.textFont('Georgia');
            p5instance.textAlign(p5instance.CENTER, p5instance.CENTER);
            p5instance.text(s, p5instance.width / 2, p5instance.height / 2 - 50);
            p5instance.textSize(25);
            p5instance.fill(50);
            p5instance.text("Start Practice by clicking below", p5instance.width / 2, 550);
            dinButtonPracticeInstruct.show(p5instance);
            dinButtonPracticeInstruct.hover(p5instance.mouseX, p5instance.mouseY, p5instance);
            flashInstruct(flashInstructFadeRate, din);
        }

        function dinPracticeTrial(p5instance) {
            p5instance.textSize(50);
            p5instance.fill(50);
            p5instance.text(dinPressList, p5instance.width / 2 - 50, 50);
            for (var i = 0; i < dinNumbBox.length; i++) {
                dinNumbBox[i].show(p5instance);
                dinNumbBox[i].mouseisover(p5instance.mouseX, p5instance.mouseY);
            };
            dinBackspace.show(p5instance); dinBackspace.mouseisover(p5instance.mouseX, p5instance.mouseY);
            if (!dinPracStimPlayed && !dinPracticeResp[1]) {
                p5instance.textSize(25);
                p5instance.text('Play Numbers', p5instance.width / 2 + 70, 580);
                dinButtonPracticeRepeat.show(p5instance);
                dinButtonPracticeRepeat.hover(p5instance.mouseX, p5instance.mouseY, p5instance);
            } else if (dinPracStimPlayed && dinTrialPresses == 3) {
                p5instance.textSize(25);
                p5instance.text('Next Trial', p5instance.width / 2 + 70, 580);
                dinButtonPracticeNext.show(p5instance);
                dinButtonPracticeNext.hover(p5instance.mouseX, p5instance.mouseY, p5instance);
            } else {
                p5instance.textSize(30); p5instance.fill('red');
                p5instance.text('choose the 3 numbers you heard or make a guess', p5instance.width / 2, 580);
            };
            flashInstruct(flashInstructFadeRate, din);
            //flashPracticeInstruct();
        }

        function dinReadySet(p5instance) {
            let s = 'Now you will begin the actual task\n\nIt will take around 3 mins\n\nPress the button below to proceed';
            p5instance.fill(0, 150);
            p5instance.textSize(30);
            p5instance.textFont('Georgia');
            p5instance.textAlign(p5instance.CENTER, p5instance.CENTER);
            p5instance.text(s, p5instance.width / 2, p5instance.height / 2 - 50);
            p5instance.textSize(25);
            p5instance.fill(50);
            p5instance.text('Start Main Task by clicking below', p5instance.width / 2, 550);
            dinButtonReadySet.show(p5instance);
            dinButtonReadySet.hover(p5instance.mouseX, p5instance.mouseY, p5instance);
            flashInstruct(flashInstructFadeRate, din);
        }

        function dinMainExp(p5instance) {
            p5instance.textSize(50);
            p5instance.fill(50);
            p5instance.text(dinPressList, p5instance.width / 2 - 50, 50);
            for (var i = 0; i < dinNumbBox.length; i++) {
                dinNumbBox[i].show(p5instance);
                dinNumbBox[i].mouseisover(p5instance.mouseX, p5instance.mouseY);
            };
            dinBackspace.show(p5instance); dinBackspace.mouseisover(p5instance.mouseX, p5instance.mouseY);
            if (dinTrialPresses == 3) {
                p5instance.fill(50);
                p5instance.textSize(25);
                p5instance.text('Accept Choice', p5instance.width / 2 + 60, 580);
                dinButtonAccept.show(p5instance);
                dinButtonAccept.hover(p5instance.mouseX, p5instance.mouseY, p5instance);
            } else {
                p5instance.textSize(30); p5instance.fill('red');
                p5instance.text('choose the 3 numbers you heard or make a guess', p5instance.width / 2, 580);
            };
            flashInstruct(flashInstructFadeRate, din);
        }

        function dinPlayTrial() {
            document.getElementById('title_div').innerHTML = "Listen to the Digits";
            dinPreDigits.play(0, 1, 1);
            setTimeout(() => {
                if (dinPracticeResp[0] != 0) {
                    //dinBgNoise.play(0, 1, vol);
                };
                let digitList = [];
                for (let i = 0; i < dinNoDigits; i++) {
                    digitList.push(i);
                };
                let tripleDigits = [];
                for (let i = 0; i < 3; i++) {
                    digitChoice = digitList.splice(Math.floor(Math.random() * digitList.length), 1)[0];
                    dinNumbProbe = dinNumbProbe + digitChoice.toString();
                    tripleDigits.push(digitChoice);
                };
                console.log(tripleDigits);

                // All digit *.flac files are loaded to cache before trial starts
                for (let i = 0; i < dinNoDigits; i++) {
                    dinNumbFiles[i] = din.loadSound('static/audio/DTT_' + i + '.flac');
                };

                // Delay of 750ms to allow files to load
                setTimeout(() => {
                    let dinMaskerArrayOrig
                    // Extract Channel Buffers
                    try {
                        for (let i = 0; i < 2; i++) {
                            dinTargetArray1[i] = dinNumbFiles[tripleDigits[0]].buffer.getChannelData(i);
                            dinTargetArray2[i] = dinNumbFiles[tripleDigits[1]].buffer.getChannelData(i);
                            dinTargetArray3[i] = dinNumbFiles[tripleDigits[2]].buffer.getChannelData(i);
                        };
                        dinMaskerArrayOrig = dinBgNoise.buffer.getChannelData(0);
                    } catch (err) {
                        for (let i = 0; i < 2; i++) {
                            dinTargetArray1[i] = dinNumbFiles[tripleDigits[0]].buffer.getChannelData(i);
                            dinTargetArray2[i] = dinNumbFiles[tripleDigits[1]].buffer.getChannelData(i);
                            dinTargetArray3[i] = dinNumbFiles[tripleDigits[2]].buffer.getChannelData(i);
                        };
                        dinMaskerArrayOrig = dinBgNoise.buffer.getChannelData(0);
                        console.log(err.message);
                    }
                    dinMaskerArray = [dinMaskerArrayOrig, dinMaskerArrayOrig];

                    if (dinExpHandler.state == 2) {
                        adjustSoundTMRdB(dinTargetArray1, 25, 2); adjustSoundTMRdB(dinTargetArray2, 25, 2); adjustSoundTMRdB(dinTargetArray3, 25, 2);
                    } else {
                        adjustSoundTMRdB(dinTargetArray1, dinTrialVolume, 2); adjustSoundTMRdB(dinTargetArray2, dinTrialVolume, 2); adjustSoundTMRdB(dinTargetArray3, dinTrialVolume, 2);
                    };
                    dinRmsCombineTMR(dinTargetArray1, dinTargetArray2, dinTargetArray3, dinMaskerArray);

                    // Inserted loop to overcome Soundproof room computer issues
                    while (dinRMS == 0) {
                        dinRmsCombineTMR(dinTargetArray1, dinTargetArray2, dinTargetArray3, dinMaskerArray);
                        console.log(dinRMS);
                    };

                    dinPlayStimuli();

                }, 750);

            }, 1000);
            flashInstruct(flashInstructFadeRate, din);
        }

        let dinTargetArray1 = [[], []]; let dinTargetArray2 = [[], []]; let dinTargetArray3 = [[], []];
        let dinMaskerArray = [[], []]; let dinCombinedArray = [[], []];

        // Create AudioContext for Combined Sound
        let dinAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let dinCombinedBuffer;

        // Combines a Target and Masker sound by using Root Mean Squared normalising for the DIN stimuli
        let dinRMS;
        function dinRmsCombineTMR(targetArray1, targetArray2, targetArray3, maskerArray) {
            let start1 = 48000 * 0.1;
            let start2 = start1 + targetArray1[0].length + 48000 * 0.2;
            let start3 = start2 + targetArray2[0].length + 48000 * 0.2;

            dinCombinedArray = [[], []];
            for (let channel = 0; channel < 2; channel++) {
                for (let i = 0; i < maskerArray[0].length; i++) {
                    dinCombinedArray[channel][i] = 0;
                };
            };

            for (let channel = 0; channel < 2; channel++) {
                let a = 0; let b = 0; let c = 0;
                for (let i = 0; i < maskerArray[0].length; i++) {
                    if ((i >= start1) && (i < (start1 + targetArray1[0].length))) {
                        dinCombinedArray[channel][i] = targetArray1[channel][a] + maskerArray[channel][i];
                        a++;
                    } else if ((i >= start2) && (i < (start2 + targetArray2[0].length))) {
                        dinCombinedArray[channel][i] = targetArray2[channel][b] + maskerArray[channel][i];
                        b++;
                    } else if ((i >= start3) && (i < (start3 + targetArray3[0].length))) {
                        dinCombinedArray[channel][i] = targetArray3[channel][c] + maskerArray[channel][i];
                        c++;
                    } else {
                        dinCombinedArray[channel][i] = 0 + maskerArray[channel][i];
                    };
                };
            };

            let dinCombinedArrayLong = dinCombinedArray[0].concat(dinCombinedArray[1]);

            // Obtain Standard Deviation (RMS) of Combined Array values
            for (let i = 0; i < dinCombinedArrayLong.length; i++) {
                dinCombinedArrayLong[i] = Math.pow(dinCombinedArrayLong[i], 2);
            };

            dinRMS = Math.sqrt((dinCombinedArrayLong.reduce((a, b) => a + b, 0) / dinCombinedArrayLong.length) || 0);
            console.log(dinRMS);

            // Normalise Concatenated Array by RMS value
            for (let channel = 0; channel < 2; channel++) {
                for (let i = 0; i < dinCombinedArray[channel].length; i++) {
                    dinCombinedArray[channel][i] = dinCombinedArray[channel][i] / (dinRMS * 5);
                };
            }

            dinCombinedArray[0] = new Float32Array(dinCombinedArray[0]);
            dinCombinedArray[1] = new Float32Array(dinCombinedArray[1]);
            dinCombinedBuffer = dinAudioCtx.createBuffer(2, dinMaskerArray[0].length, dinAudioCtx.sampleRate);

            for (let channel = 0; channel < 2; channel++) {
                dinCombinedBuffer.copyToChannel(dinCombinedArray[channel], channel, 0);
            };
        }

        // Play Adjusted DIN Stimulus
        function dinPlayStimuli() {
            let source = dinAudioCtx.createBufferSource();
            source.buffer = dinCombinedBuffer;
            source.connect(dinAudioCtx.destination);
            source.start();

        }

        // Evaluate Responses in the Trial
        function dinEvalNumbChoices() {
            if (dinTrialPresses == 3) {
                if (dinPressList == dinNumbProbe) {
                    document.getElementById('title_div').innerHTML = 'Correct';
                    console.log('Correct');
                    // for (var i=0; i<dinPressList.length; i++) {
                    //     dinNumbBox[Number(dinPressList[i])].fillVal = 'rgba(0,255,0, 0.25)';
                    // };
                    if (dinExpHandler.state == 4) {
                        dinTrialVerdict.push(1);
                    } else {
                        dinPracticeResp[dinPracIdx] = 1;
                        dinPracIdx++;
                    };
                } else {
                    document.getElementById('title_div').innerHTML = 'Wrong';
                    console.log('Wrong');
                    // for (var i=0; i<dinPressList.length; i++) {
                    //     dinNumbBox[Number(dinPressList[i])].fillVal = 'rgba(255,0,0, 0.25)';
                    // };
                    if (dinExpHandler.state == 4) {
                        dinTrialVerdict.push(0);
                    };
                };
            } else {
                document.getElementById('title_div').innerHTML = 'Please make sure you choose three numbers';
                setTimeout(function () {
                    document.getElementById('title_div').innerHTML = "Practice";
                }, 1500);
            };
            dinPressList = ""; dinNumbProbe = "";
            dinTrialPresses = 0;
        }

        function dinAdaptiveExpTrial(result) {
            // Main function to adapt the sentence (signal) to babble (target) volume ratio
            if (dinTrialVerdict.length > 1 && (dinTrialVerdict[dinTrialVerdict.length - 2] != dinTrialVerdict[dinTrialVerdict.length - 1])) {
                dinReversals += 1;
                dinRevVols.push(dinTrialVolume);
                console.log('Reversal detected');
            };
            if (dinReversals < maxReversals) {
                for (let i = 0; i < dinRevSteps.length; i++) {
                    if (dinReversals <= dinRevSteps[i]) {
                        if (result == 1) {
                            dinTrialVolume -= dinVoldBSteps[i];
                        } else {
                            dinTrialVolume += dinVoldBSteps[i];
                        };
                        dinTrialVols.push(dinTrialVolume - dinStartTrialVolume);
                        break
                    };
                };

                console.log('The volume is set at ' + (dinTrialVolume - dinStartTrialVolume));
                setTimeout(function () {
                    dinPlayTrial(dinTrialVolume);
                }, 3000);
            } else {
                dinExpHandler.state = 5;
            };
        }

        // Takes a sound array and the required dB value to adjust sound array and plays it
        function adjustSoundTMRdB(soundArray, dB, channels) {
            if (channels == 2) {
                for (let channel = 0; channel < 2; channel++) {
                    for (let i = 0; i < soundArray[channel].length; i++) {
                        soundArray[channel][i] = soundArray[channel][i] * Math.pow(10, dB / 20);
                    };
                };
            } else {
                for (let i = 0; i < soundArray.length; i++) {
                    soundArray[i] = soundArray[i] * Math.pow(10, dB / 20);
                };
            };
        }

        // Calculates threshold for task based on inputted last number of reversals
        function calcThreshold(array, number) {
            let revs = [];
            for (let x = -number; x < 0; x++) {
                revs.push(array[array.length + x]);
            };
            return (revs.reduce((a, b) => a + b, 0) / revs.length);
        }
    </script>

</body>

</html>